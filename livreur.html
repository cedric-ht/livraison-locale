<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Livreur - Terroir Sables</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
  background: #F5F1E8;
  color: #2C2C2C;
  min-height: 100vh;
  padding: 2rem 1rem;
  line-height: 1.6;
}

h1, h2, h3, h4 {
  font-family: 'Playfair Display', serif;
  color: #2C2C2C;
}

.box {
  max-width: 900px;
  margin: auto;
  background: #FEFEFE;
  padding: 2.5rem;
  border-radius: 24px;
  box-shadow: 0 15px 40px rgba(107, 44, 62, 0.15);
  border: 2px solid #F5F1E8;
}

h2 {
  text-align: center;
  margin-bottom: 2rem;
  font-size: 2rem;
  color: #6B2C3E;
}

input {
  width: 100%;
  padding: 1rem;
  margin-bottom: 1.2rem;
  border-radius: 14px;
  border: 2px solid #F5F1E8;
  font-family: 'Inter', sans-serif;
  font-size: 1rem;
  transition: border 0.2s ease;
}

input:focus {
  outline: none;
  border-color: #8B9D83;
}

button {
  padding: 1rem 1.5rem;
  border-radius: 14px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  font-family: 'Inter', sans-serif;
  font-size: 1rem;
  transition: all 0.3s ease;
}

button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.primary {
  background: linear-gradient(135deg, #8B9D83, #A4B89C);
  color: white;
  width: 100%;
}

.primary:hover {
  box-shadow: 0 8px 20px rgba(139, 157, 131, 0.4);
}

.danger {
  background: #D64545;
  color: white;
  width: 100%;
  margin-top: 2rem;
}

.danger:hover {
  background: #B03030;
}

.off {
  background: #ADB5BD;
  color: white;
  width: 100%;
}

.off:hover {
  background: #8B9197;
}

.hidden {
  display: none;
}

.order {
  border: 2px solid #F5F1E8;
  border-radius: 20px;
  padding: 1.5rem;
  margin: 1.5rem 0;
  background: rgba(245, 241, 232, 0.3);
  transition: all 0.3s ease;
}

.order:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 25px rgba(107, 44, 62, 0.12);
  border-color: #8B9D83;
}

.order h4 {
  margin: 0 0 0.8rem 0;
  font-size: 1.3rem;
  color: #6B2C3E;
}

.order small {
  color: #6B6B6B;
  display: block;
  margin-bottom: 0.5rem;
}

.order p {
  font-weight: 600;
  color: #2C2C2C;
  margin: 0.8rem 0 1rem 0;
  font-size: 1.1rem;
}

.order button {
  margin-top: 1rem;
}

.status {
  text-align: center;
  font-weight: 700;
  margin: 2rem 0;
  padding: 1.2rem;
  border-radius: 16px;
  font-size: 1.2rem;
  background: rgba(139, 157, 131, 0.15);
  color: #6B2C3E;
  border: 2px solid #8B9D83;
}

#toggleBtn {
  margin-bottom: 1rem;
}

#ordersBox {
  margin-top: 2rem;
}

.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: #6B6B6B;
  font-style: italic;
}

@media (max-width: 768px) {
  .box {
    padding: 1.5rem;
  }

  h2 {
    font-size: 1.6rem;
  }

  .order {
    padding: 1rem;
  }
}
</style>
</head>

<body>

<div class="box" id="loginBox">
  <h2>üá´üá∑ Connexion Livreur</h2>
  <p style="text-align:center; color:#6B6B6B; margin-bottom:2rem;">Terroir Sables - Espace Livreur</p>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Mot de passe">
  <button class="primary" onclick="login()">Se connecter</button>
</div>

<div class="box hidden" id="dashboard">
  <h2>Dashboard Livreur</h2>

  <button id="toggleBtn" onclick="toggleService()">Se mettre en service</button>
  <div class="status" id="statusText"></div>

  <div id="ordersBox"></div>

  <button class="danger" onclick="logout()">D√©connexion</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  collection,
  query,
  where,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid = null;
let online = false;
let unsubscribeOrders = null;

/* ================= AUTH ================= */
onAuthStateChanged(auth, async user=>{
  if(!user){
    loginBox.classList.remove("hidden");
    dashboard.classList.add("hidden");
    return;
  }

  uid = user.uid;

  const userSnap = await getDoc(doc(db,"users",uid));
  if(!userSnap.exists() || userSnap.data().role !== "livreur"){
    alert("Acc√®s refus√© - Compte livreur requis");
    await signOut(auth);
    return;
  }

  const livreurRef = doc(db,"livreurs",uid);
  const snap = await getDoc(livreurRef);

  if(!snap.exists()){
    await setDoc(livreurRef,{online:false,active:true});
    online = false;
  }else{
    online = snap.data().online;
  }

  updateUI();

  if(online){
    listenOrders();
  }

  loginBox.classList.add("hidden");
  dashboard.classList.remove("hidden");
});

/* ================= LOGIN ================= */
window.login = async ()=>{
  try{
    await signInWithEmailAndPassword(auth,email.value,password.value);
  }catch(e){
    alert("Erreur de connexion - V√©rifiez vos identifiants");
  }
};

window.logout = async ()=>{
  if(confirm("Vous d√©connecter ?")){
    await signOut(auth);
  }
};

/* ================= SERVICE ================= */
window.toggleService = async ()=>{
  online = !online;
  await updateDoc(doc(db,"livreurs",uid),{online});
  updateUI();
  online ? listenOrders() : stopOrders();
};

function updateUI(){
  toggleBtn.innerText = online ? "üî¥ Se mettre hors service" : "üü¢ Se mettre en service";
  toggleBtn.className = online ? "off" : "primary";
  statusText.innerText = online ? "üü¢ Vous √™tes en service" : "üî¥ Vous √™tes hors service";
  statusText.style.borderColor = online ? "#8B9D83" : "#ADB5BD";
  statusText.style.background = online ? "rgba(139, 157, 131, 0.15)" : "rgba(173, 181, 189, 0.15)";
}

/* ================= COMMANDES ================= */
function listenOrders(){
  if(unsubscribeOrders) unsubscribeOrders();

  unsubscribeOrders = onSnapshot(
    collection(db,"commandes"),
    snap=>{
      ordersBox.innerHTML = "";

      let hasOrders = false;

      snap.forEach(d=>{
        const c = d.data();

        // on ne montre que les commandes utiles
        if(
          c.status !== "prete" &&
          !(c.status === "en_livraison" && c.livreurId === uid)
        ) return;

        hasOrders = true;

        const div = document.createElement("div");
        div.className="order";
        
        const statusEmoji = c.status === "prete" ? "üì¶" : "üö¥‚Äç‚ôÇÔ∏è";
        const statusText = c.status === "prete" ? "Pr√™te √† livrer" : "En cours de livraison";

        div.innerHTML=`
          <h4>${statusEmoji} Commande</h4>
          <small><strong>${c.client.nom}</strong></small>
          <small>üìç ${c.client.adresse}</small>
          <p>üí∞ Total : ${c.total.toFixed(2)} ‚Ç¨</p>
          <small style="color:#8B9D83;font-weight:600;">${statusText}</small>
        `;

        const btn = document.createElement("button");
        btn.className="primary";

        if(c.status === "prete"){
          btn.innerText = "‚úÖ Prendre la commande";
          btn.onclick = ()=>takeOrder(d.id);
        }else{
          btn.innerText = "‚úÖ Marquer livr√©e";
          btn.onclick = ()=>finishOrder(d.id);
        }

        div.appendChild(btn);
        ordersBox.appendChild(div);
      });

      if(!hasOrders){
        ordersBox.innerHTML = `
          <div class="empty-state">
            <p>üì≠ Aucune commande disponible pour le moment</p>
            <p style="font-size:0.9rem; margin-top:0.5rem;">Les nouvelles commandes appara√Ætront ici automatiquement</p>
          </div>
        `;
      }
    }
  );
}

function stopOrders(){
  ordersBox.innerHTML = `
    <div class="empty-state">
      <p>üî¥ Service d√©sactiv√©</p>
      <p style="font-size:0.9rem; margin-top:0.5rem;">Activez le service pour voir les commandes disponibles</p>
    </div>
  `;
  if(unsubscribeOrders) unsubscribeOrders();
}

async function takeOrder(id){
  if(confirm("Prendre cette commande en charge ?")){
    await updateDoc(doc(db,"commandes",id),{
      status:"en_livraison",
      livreurId: uid,
      takenAt: new Date()
    });
  }
}

async function finishOrder(id){
  if(confirm("Confirmer la livraison ?")){
    await updateDoc(doc(db,"commandes",id),{
      status:"livree",
      deliveredAt: new Date()
    });
  }
}
</script>

</body>
</html>
