<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Livreur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  font-family: system-ui, -apple-system, sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:2rem;
}
.box{
  max-width:400px;
  margin:auto;
  background:white;
  padding:2rem;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.1);
}
h2{text-align:center;margin-bottom:1rem}
input,button{
  width:100%;
  padding:.8rem;
  margin:.4rem 0;
  border-radius:10px;
  border:1px solid #ccc;
}
button{
  background:#0077b6;
  color:white;
  border:none;
  font-weight:600;
  cursor:pointer;
}
button.off{
  background:#adb5bd;
}
.hidden{display:none}
.status{
  text-align:center;
  font-weight:600;
  margin-top:1rem;
}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <h2>Connexion livreur</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Mot de passe">
  <button onclick="login()">Se connecter</button>
</div>

<div class="box hidden" id="dashboard">
  <h2>Dashboard Livreur</h2>

  <button id="toggleBtn" onclick="toggleService()">Se mettre en service</button>
  <div class="status" id="statusText"></div>

  <button style="margin-top:1rem;background:#ff595e" onclick="logout()">DÃ©connexion</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise",
  storageBucket: "livraison-sablaise.firebasestorage.app",
  messagingSenderId: "930839535214",
  appId: "1:930839535214:web:a3235919aa88d066bc507f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUid = null;
let online = false;

// AUTH CHECK
onAuthStateChanged(auth, async user=>{
  if(!user){
    loginBox.classList.remove("hidden");
    dashboard.classList.add("hidden");
    return;
  }

  currentUid = user.uid;

  // vÃ©rifier rÃ´le
  const userSnap = await getDoc(doc(db,"users",user.uid));
  if(!userSnap.exists() || userSnap.data().role !== "livreur"){
    alert("AccÃ¨s refusÃ©");
    await signOut(auth);
    return;
  }

  // charger Ã©tat livreur
  const livreurRef = doc(db,"livreurs",user.uid);
  const livreurSnap = await getDoc(livreurRef);
  online = livreurSnap.exists() ? livreurSnap.data().online : false;

  updateUI();
  loginBox.classList.add("hidden");
  dashboard.classList.remove("hidden");
});

// LOGIN
window.login = async ()=>{
  try{
    await signInWithEmailAndPassword(
      auth,
      email.value,
      password.value
    );
  }catch(e){
    alert("Erreur de connexion");
  }
};

// LOGOUT
window.logout = async ()=>{
  await signOut(auth);
};

// TOGGLE SERVICE
window.toggleService = async ()=>{
  online = !online;
  await updateDoc(doc(db,"livreurs",currentUid),{
    online: online
  });
  updateUI();
};

function updateUI(){
  toggleBtn.innerText = online ? "Se mettre hors service" : "Se mettre en service";
  toggleBtn.className = online ? "" : "off";
  statusText.innerText = online ? "ðŸŸ¢ En service" : "ðŸ”´ Hors service";
}
</script>

</body>
</html>