<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Livreur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: system-ui, -apple-system, sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:2rem;
}
.box{
  max-width:800px;
  margin:auto;
  background:white;
  padding:2rem;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.1);
}
h2{text-align:center;margin-bottom:1rem}
button{
  padding:.7rem 1rem;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:600;
}
.primary{background:#0077b6;color:white}
.danger{background:#ff595e;color:white}
.off{background:#adb5bd;color:white}
.hidden{display:none}

.order{
  border:1px solid #eee;
  border-radius:12px;
  padding:1rem;
  margin:1rem 0;
}
.order h4{margin:.2rem 0}
.order small{color:#666}

.status{
  text-align:center;
  font-weight:600;
  margin:1rem 0;
}
</style>
</head>

<body>

<div class="box" id="loginBox">
  <h2>Connexion livreur</h2>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Mot de passe">
  <button class="primary" onclick="login()">Se connecter</button>
</div>

<div class="box hidden" id="dashboard">
  <h2>Dashboard Livreur</h2>

  <button id="toggleBtn" onclick="toggleService()">Se mettre en service</button>
  <div class="status" id="statusText"></div>

  <div id="ordersBox"></div>

  <button class="danger" onclick="logout()">DÃ©connexion</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  collection,
  query,
  where,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid = null;
let online = false;
let unsubscribeOrders = null;

/* ================= AUTH ================= */
onAuthStateChanged(auth, async user=>{
  if(!user){
    loginBox.classList.remove("hidden");
    dashboard.classList.add("hidden");
    return;
  }

  uid = user.uid;

  const userSnap = await getDoc(doc(db,"users",uid));
  if(!userSnap.exists() || userSnap.data().role !== "livreur"){
    alert("AccÃ¨s refusÃ©");
    await signOut(auth);
    return;
  }

  const livreurRef = doc(db,"livreurs",uid);
  const snap = await getDoc(livreurRef);

  if(!snap.exists()){
    await setDoc(livreurRef,{online:false,active:true});
    online = false;
  }else{
    online = snap.data().online;
  }

  updateUI();

  if(online){
    listenOrders();
  }

  loginBox.classList.add("hidden");
  dashboard.classList.remove("hidden");
});

/* ================= LOGIN ================= */
window.login = async ()=>{
  try{
    await signInWithEmailAndPassword(auth,email.value,password.value);
  }catch(e){
    alert("Erreur de connexion");
  }
};

window.logout = async ()=>{
  await signOut(auth);
};

/* ================= SERVICE ================= */
window.toggleService = async ()=>{
  online = !online;
  await updateDoc(doc(db,"livreurs",uid),{online});
  updateUI();
  online ? listenOrders() : stopOrders();
};

function updateUI(){
  toggleBtn.innerText = online ? "Se mettre hors service" : "Se mettre en service";
  toggleBtn.className = online ? "primary" : "off";
  statusText.innerText = online ? "ðŸŸ¢ En service" : "ðŸ”´ Hors service";
}

/* ================= COMMANDES ================= */
function listenOrders(){
  if(unsubscribeOrders) unsubscribeOrders();

  unsubscribeOrders = onSnapshot(
    collection(db,"commandes"),
    snap=>{
      ordersBox.innerHTML = "";

      snap.forEach(d=>{
        const c = d.data();

        // on ne montre que les commandes utiles
        if(
          c.status !== "prete" &&
          !(c.status === "en_livraison" && c.livreurId === uid)
        ) return;

        const div = document.createElement("div");
        div.className="order";
        div.innerHTML=`
          <h4>Commande ${d.id}</h4>
          <small>${c.client.nom} â€“ ${c.client.adresse}</small>
          <p>Total : ${c.total} â‚¬</p>
        `;

        const btn = document.createElement("button");
        btn.className="primary";

        if(c.status === "prete"){
          btn.innerText = "Prendre la commande";
          btn.onclick = ()=>takeOrder(d.id);
        }else{
          btn.innerText = "Marquer livrÃ©e";
          btn.onclick = ()=>finishOrder(d.id);
        }

        div.appendChild(btn);
        ordersBox.appendChild(div);
      });
    }
  );
}

function stopOrders(){
  ordersBox.innerHTML="";
  if(unsubscribeOrders) unsubscribeOrders();
}

async function takeOrder(id){
  await updateDoc(doc(db,"commandes",id),{
    status:"en_livraison",
    livreurId: uid
  });
}

async function finishOrder(id){
  await updateDoc(doc(db,"commandes",id),{
    status:"livree"
  });
}
</script>

</body>
</html>