<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Commer√ßant</title>
  <style>
    body {font-family: Arial, sans-serif; max-width: 600px; margin:auto; padding:2rem;}
    h2, h3 {color:#0077b6;}
    ul {list-style:none; padding:0;}
    li {margin:0.5rem 0; display:flex; justify-content:space-between; align-items:center;}
    button {padding:0.3rem 0.6rem; cursor:pointer; margin-left:0.3rem;}
    .available {background:#2d6a4f; color:white; border:none;}
    .unavailable {background:#d00000; color:white; border:none;}
    .form-group {margin-bottom:1rem;}
    input[type=text], input[type=number] {padding:0.4rem; width:60%; margin-right:0.5rem;}
  </style>
</head>
<body>

<h2>Mes produits</h2>
<ul id="productList"></ul>

<h3>Ajouter un produit</h3>
<div class="form-group">
  <input type="text" id="newName" placeholder="Nom du produit">
  <input type="number" id="newPrice" placeholder="Prix (ex: 1.2)">
  <label>
    Disponible <input type="checkbox" id="newAvailable" checked>
  </label>
  <button onclick="addProduct()">Ajouter</button>
</div>

<button onclick="logout()" style="margin-top:2rem;">Se d√©connecter</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, collection, doc, getDocs, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // üîë REMPLACE avec TES valeurs Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
    authDomain: "livraison-sablaise.firebaseapp.com",
    projectId: "livraison-sablaise",
    storageBucket: "livraison-sablaise.firebasestorage.app",
    messagingSenderId: "930839535214",
    appId: "1:930839535214:web:a3235919aa88d066bc507f",
    measurementId: "G-R3ZCGLQ69E"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async user => {
    if (!user) {
      window.location.href = "login.html"; 
      return;
    }

    const productList = document.getElementById("productList");
    productList.innerHTML = "";

    const productsRef = collection(db, "commerces", user.uid, "produits");
    const snapshot = await getDocs(productsRef);

    snapshot.forEach(docSnap => {
      const product = docSnap.data();
      const li = document.createElement("li");
      li.innerHTML = `
        <span>${product.name} - ${product.price}‚Ç¨</span>
        <div>
          <button class="${product.available ? 'available' : 'unavailable'}">${product.available ? 'Disponible' : 'Indisponible'}</button>
          <button style="background:#555;color:white;border:none;">Supprimer</button>
        </div>
      `;
      
      const dispoBtn = li.querySelector("button:first-of-type");
      const delBtn = li.querySelector("button:last-of-type");

      // Basculer Disponible / Indisponible
      dispoBtn.onclick = async () => {
        const newStatus = !product.available;
        await updateDoc(doc(db, "commerces", user.uid, "produits", docSnap.id), {available: newStatus});
        dispoBtn.innerText = newStatus ? "Disponible" : "Indisponible";
        dispoBtn.className = newStatus ? "available" : "unavailable";
        product.available = newStatus; 
      };

      // Supprimer le produit
      delBtn.onclick = async () => {
        if(confirm(`Supprimer le produit "${product.name}" ?`)) {
          await deleteDoc(doc(db, "commerces", user.uid, "produits", docSnap.id));
          li.remove();
        }
      };

      productList.appendChild(li);
    });
  });

  // Ajouter un produit
  window.addProduct = async function() {
    const name = document.getElementById("newName").value.trim();
    const price = parseFloat(document.getElementById("newPrice").value);
    const available = document.getElementById("newAvailable").checked;

    if (!name || isNaN(price)) {
      alert("Nom et prix valides requis !");
      return;
    }

    const productsRef = collection(db, "commerces", auth.currentUser.uid, "produits");
    await addDoc(productsRef, { name, price, available });

    alert("Produit ajout√© !");
    location.reload(); // recharge pour voir le nouveau produit
  };

  // D√©connexion
  window.logout = function() {
    signOut(auth).then(() => {
      window.location.href = "login.html";
    }).catch(err => alert("Erreur d√©connexion : " + err.message));
  }
</script>

</body>
</html>
