<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Commer√ßant - Terroir Sables</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #F5F1E8;
  color: #2C2C2C;
  line-height: 1.6;
}

h1, h2, h3 {
  font-family: 'Playfair Display', serif;
  color: #2C2C2C;
}

header {
  background: linear-gradient(135deg, #6B2C3E, #8B4C5E);
  color: white;
  text-align: center;
  padding: 2.5rem 1.5rem;
  box-shadow: 0 10px 35px rgba(107, 44, 62, 0.25);
  position: relative;
}

header h1 {
  font-size: 2.2rem;
  margin-bottom: 0.5rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}

header p {
  opacity: 0.92;
  font-size: 1rem;
  margin-bottom: 1.5rem;
}

section {
  padding: 2.5rem 1.5rem;
  max-width: 1200px;
  margin: auto;
}

h2 {
  margin-bottom: 1.5rem;
  margin-top: 2rem;
  font-size: 1.8rem;
  color: #6B2C3E;
}

button {
  padding: 0.7rem 1.3rem;
  border: none;
  border-radius: 14px;
  background: linear-gradient(135deg, #6B2C3E, #8B4C5E);
  color: white;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
  font-size: 0.95rem;
}

button:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(107, 44, 62, 0.3);
}

#logout {
  background: #D64545;
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
}

#logout:hover {
  background: #B03030;
}

#productList {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 2rem;
  margin-top: 1.5rem;
}

.productCard {
  background: #FEFEFE;
  padding: 1.5rem;
  border-radius: 20px;
  border: 2px solid #F5F1E8;
  box-shadow: 0 8px 20px rgba(107, 44, 62, 0.08);
  transition: all 0.3s ease;
}

.productCard:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(107, 44, 62, 0.15);
  border-color: #8B9D83;
}

.productCard h3 {
  font-size: 1.2rem;
  margin-bottom: 0.5rem;
  color: #6B2C3E;
}

.productCard p {
  margin: 0.5rem 0;
  color: #6B6B6B;
}

.stockControls {
  display: flex;
  gap: 10px;
  align-items: center;
  margin: 15px 0;
}

.stockControls button {
  padding: 0.5rem 0.8rem;
  font-size: 1.1rem;
  background: linear-gradient(135deg, #8B9D83, #A4B89C);
}

.stockControls button:hover {
  transform: scale(1.1);
}

.unavailable {
  color: #D64545;
  font-style: italic;
  font-weight: 600;
}

form {
  background: #FEFEFE;
  padding: 2rem;
  border-radius: 20px;
  border: 2px solid #F5F1E8;
  box-shadow: 0 8px 20px rgba(107, 44, 62, 0.08);
  margin-bottom: 2rem;
}

form input {
  width: 100%;
  padding: 0.9rem;
  margin-bottom: 1rem;
  border-radius: 14px;
  border: 2px solid #F5F1E8;
  font-family: 'Inter', sans-serif;
  font-size: 1rem;
  transition: border 0.2s ease;
}

form input:focus {
  outline: none;
  border-color: #8B9D83;
}

form button {
  width: 100%;
  padding: 1rem;
  font-size: 1rem;
}

#ordersHistory .productCard {
  opacity: 0.75;
  font-size: 0.95rem;
}

#ordersHistory .productCard:hover {
  opacity: 1;
}

.productCard[data-status="en_attente"] {
  border-left: 6px solid #FFB703;
  background: rgba(255, 183, 3, 0.05);
}

.productCard[data-status="prete"] {
  border-left: 6px solid #FB8500;
  background: rgba(251, 133, 0, 0.05);
}

.productCard[data-status="en_livraison"] {
  border-left: 6px solid #8B9D83;
  background: rgba(139, 157, 131, 0.05);
}

.productCard[data-status="livree"] {
  border-left: 6px solid #2A9D8F;
  background: rgba(42, 157, 143, 0.05);
}

.productCard[data-status="annulee"] {
  border-left: 6px solid #D64545;
  background: rgba(214, 69, 69, 0.05);
  opacity: 0.6;
}

.productCard img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 16px;
  margin-bottom: 1rem;
  box-shadow: 0 6px 15px rgba(107, 44, 62, 0.1);
}

.productCard label {
  display: block;
  font-weight: 600;
  margin-top: 1rem;
  margin-bottom: 0.5rem;
  color: #6B2C3E;
}

.productCard input[type="number"] {
  width: 100%;
  padding: 0.6rem;
  border-radius: 10px;
  border: 2px solid #F5F1E8;
  font-family: 'Inter', sans-serif;
}

.productCard input[type="number"]:focus {
  outline: none;
  border-color: #8B9D83;
}

.productCard button {
  margin-top: 0.8rem;
  width: 100%;
}

.productCard button:nth-child(n+2) {
  background: #D64545;
  margin-top: 0.5rem;
}

.productCard button:nth-child(n+2):hover {
  background: #B03030;
}

#ordersList, #ordersHistory {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.8rem;
  margin-top: 1.5rem;
}

.productCard strong {
  font-size: 1.1rem;
  color: #6B2C3E;
  display: block;
  margin-bottom: 0.5rem;
}

@media (max-width: 768px) {
  header h1 {
    font-size: 1.8rem;
  }
  
  #logout {
    position: static;
    margin-top: 1rem;
    width: 100%;
  }

  #productList, #ordersList, #ordersHistory {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<header>
  <h1>üá´üá∑ Dashboard Commer√ßant</h1>
  <p>Gestion des produits et commandes - Terroir Sables</p>
  <button id="logout">Se d√©connecter</button>
</header>

<section>
<h2>Ajouter un produit</h2>
<form id="addProductForm">
  <input type="file" id="productImage" accept="image/*">
  <input type="text" id="productName" placeholder="Nom du produit" required>
  <input type="text" id="productPrice" placeholder="Prix (‚Ç¨)" required>
  <input type="number" id="productStock" placeholder="Stock initial" min="0" required>
  <button type="submit">Ajouter produit</button>
</form>

<h2>Mes produits</h2>
<div id="productList"></div>

<h2>Commandes en cours</h2>
<div id="ordersList"></div>

<h2>Historique des commandes</h2>
<div id="ordersHistory"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  deleteDoc,
  onSnapshot,
  updateDoc,
  getDoc,
  query,
  where
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise",
  storageBucket: "livraison-sablaise.firebasestorage.app",
  messagingSenderId: "930839535214",
  appId: "1:930839535214:web:a3235919aa88d066bc507f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let uid;

// Auth
onAuthStateChanged(auth, async user => {
  if(!user){
    window.location.href = "login.html";
    return;
  }

  uid = user.uid;
  const commerceRef = doc(db, "commerces", uid);
  const commerceSnap = await getDoc(commerceRef);

  if(!commerceSnap.exists()){
    await signOut(auth);
    alert("Acc√®s refus√©");
    window.location.href = "index.html";
    return;
  }

  loadProducts();
  loadOrders();
});

// Logout
document.getElementById("logout").onclick = () =>
  signOut(auth).then(()=> window.location.href="login.html");

// Ajouter produit
document.getElementById("addProductForm").addEventListener("submit", async e=>{
  e.preventDefault();

  const name = productName.value;
  const price = productPrice.value.replace(",", ".");
  const stock = parseInt(productStock.value);
  const imageFile = productImage.files[0];

  let imageUrl = null;

  if(imageFile){
    const imageRef = ref(
      storage,
      `produits/${uid}/${Date.now()}_${imageFile.name}`
    );

    await uploadBytes(imageRef, imageFile);
    imageUrl = await getDownloadURL(imageRef);
  }

  await addDoc(collection(db,"commerces",uid,"produits"),{
    name,
    price,
    stock,
    available: stock > 0,
    imageUrl,
    maxPerDelivery: 0,
  });

  e.target.reset();
});

// Modifier stock
async function updateStock(productId, currentStock, delta){
  const newStock = Math.max(0, currentStock + delta);
  await updateDoc(doc(db,"commerces",uid,"produits",productId),{
    stock: newStock,
    available: newStock > 0
  });
}

// Modifier max par client
window.updateMaxPerClient = async function(productId, value){
  const max = Math.max(0, parseInt(value) || 0);

  await updateDoc(
    doc(db,"commerces",uid,"produits",productId),
    { maxPerDelivery: max }
  );
};

// Affichage produits
function loadProducts(){
  onSnapshot(collection(db,"commerces",uid,"produits"), snapshot=>{
    productList.innerHTML="";
    snapshot.forEach(docSnap=>{
      const p = docSnap.data();
      const div = document.createElement("div");
      div.className="productCard";
      div.innerHTML=`
  ${p.imageUrl ? `<img src="${p.imageUrl}">` : ""}
  <h3>${p.name}</h3>
  <p>Prix : ${p.price} ‚Ç¨</p>
  <p>Stock restant : <strong>${p.stock}</strong></p>

  <div class="stockControls">
    <button onclick="updateStock('${docSnap.id}', ${p.stock}, -1)">‚ûñ</button>
    <button onclick="updateStock('${docSnap.id}', ${p.stock}, 1)">‚ûï</button>
  </div>

  <label>Max par client :</label>
  <input type="number"
         min="0"
         value="${p.maxPerDelivery ?? 0}"
         onchange="updateMaxPerClient('${docSnap.id}', this.value)">

  <p class="${p.available ? '' : 'unavailable'}">
    ${p.available ? '‚úÖ Disponible' : '‚ùå Indisponible'}
  </p>

  <button onclick="deleteProduct('${docSnap.id}')">Supprimer</button>
`;
      productList.appendChild(div);
    });
  });
}

window.updateStock = updateStock;

window.deleteProduct = async id => {
  if(confirm("Supprimer ce produit ?")){
    await deleteDoc(doc(db,"commerces",uid,"produits",id));
  }
};

function loadOrders(){
  const ordersList = document.getElementById("ordersList");
  const ordersHistory = document.getElementById("ordersHistory");

  const q = query(
    collection(db,"commandes"),
    where("commerceId","==",uid)
  );

  onSnapshot(q, snapshot=>{
    ordersList.innerHTML = "";
    ordersHistory.innerHTML = "";

    snapshot.docs
     .reverse()
     .forEach(docSnap=>{
       const o = docSnap.data();

      const div = document.createElement("div");
      div.className = "productCard";
      div.dataset.status = o.status;

      let action = "";

      if(o.status === "en_attente"){
        action = `
          <button onclick="markReady('${docSnap.id}')">Marquer pr√™te</button>
          <button style="background:#D64545;margin-left:8px"
            onclick="cancelOrder('${docSnap.id}')">
            Annuler
          </button>
        `;
      }
      else if(o.status === "prete"){
        action = `<em style="color:#8B9D83;">En attente de livreur</em>`;
      }
      else if(o.status === "en_livraison"){
        action = `<em style="color:#8B9D83;">Livreur en route</em>`;
      }
      else{
        action = `<em style="color:#6B6B6B;">Commande termin√©e</em>`;
      }

      div.innerHTML = `
        <strong>Commande</strong><br>
        ${o.client.nom}<br>
        Total : ${o.total.toFixed(2)} ‚Ç¨<br>
        Statut : <strong>${statusLabel(o.status)}</strong><br><br>
        ${action}
      `;

      if(o.status === "livree"){
        ordersHistory.appendChild(div);
      }else{
        ordersList.appendChild(div);
      }
    });
  });
}

window.markReady = async function(orderId){
  const ref = doc(db,"commandes",orderId);
  const snap = await getDoc(ref);

  if(!snap.exists()) return;

  const data = snap.data();

  if(data.commerceId !== uid || data.status !== "en_attente"){
    alert("Action interdite");
    return;
  }

  await updateDoc(ref,{
    status: "prete"
  });
}

window.cancelOrder = async function(orderId){
  if(!confirm("Annuler cette commande ? Le client sera rembours√©.")) return;

  const ref = doc(db,"commandes",orderId);
  const snap = await getDoc(ref);

  if(!snap.exists()) return;

  const data = snap.data();

  if(data.commerceId !== uid || data.status !== "en_attente"){
    alert("Action interdite");
    return;
  }

  await updateDoc(ref,{
    status: "annulee",
    cancelledAt: new Date()
  });
}

function statusLabel(status){
  switch(status){
    case "en_attente": return "üïì En attente";
    case "prete": return "üü† Pr√™te (attente livreur)";
    case "en_livraison": return "üü£ En livraison";
    case "livree": return "üü¢ Livr√©e";
    case "annulee": return "‚ùå Annul√©e";
    default: return status;
  }
}
</script>

</body>
</html>
