<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard CommerÃ§ant - Livraison Locale</title>
<style>
body {font-family:'Segoe UI', Tahoma, sans-serif; background:#f4f6f8; margin:0;}
header {background:#00b4d8; color:white; text-align:center; padding:2rem;}
header h1 {font-size:2.5rem;}
section {padding:2rem; max-width:1000px; margin:auto;}
button {padding:0.5rem 1rem; border:none; border-radius:10px; background:#0077b6; color:white; cursor:pointer;}
button:hover {background:#0096c7;}
#logout {background:#ff595e;}
#logout:hover {background:#ff2e33;}
#productList {display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:1.5rem;}
.productCard {background:white; padding:1rem; border-radius:15px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.stockControls {display:flex; gap:10px; align-items:center; margin:10px 0;}
.unavailable {color:#999; font-style:italic;}
form input {width:100%; padding:0.6rem; margin-bottom:0.6rem; border-radius:10px; border:1px solid #ccc;}
#ordersHistory .productCard {
  opacity: 0.7;
  font-size: 0.9rem;
}

#ordersHistory .productCard:hover {
  opacity: 1;
}
.productCard[data-status="en_attente"] {
  border-left: 6px solid #ffb703;
}

.productCard[data-status="prete"] {
  border-left: 6px solid #fb8500;
}

.productCard[data-status="en_livraison"] {
  border-left: 6px solid #8338ec;
}

.productCard[data-status="livree"] {
  border-left: 6px solid #2a9d8f;
}

.productCard[data-status="annulee"] {
  border-left: 6px solid #ff595e;
  opacity: 0.6;
}

</style>
</head>
<body>

<header>
  <h1>Dashboard CommerÃ§ant</h1>
  <p>Gestion des produits et du stock</p>
  <button id="logout">Se dÃ©connecter</button>
</header>

<section>
<h2>Ajouter un produit</h2>
<form id="addProductForm">
  <input type="file" id="productImage" accept="image/*" required>
  <input type="text" id="productName" placeholder="Nom du produit" required>
  <input type="text" id="productPrice" placeholder="Prix (â‚¬)" required>
  <input type="number" id="productStock" placeholder="Stock initial" min="0" required>
  <button type="submit">Ajouter produit</button>
</form>

<h2>Mes produits</h2>
<div id="productList"></div>

<h2>Commandes en cours</h2>
<div id="ordersList"></div>

<h2>Historique des commandes</h2>
<div id="ordersHistory"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  deleteDoc,
  onSnapshot,
  updateDoc,
  getDoc,
  query,
  where
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise",
  storageBucket: "livraison-sablaise.firebasestorage.app",
  messagingSenderId: "930839535214",
  appId: "1:930839535214:web:a3235919aa88d066bc507f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let uid;

// Auth
onAuthStateChanged(auth, async user => {
  if(!user){
    window.location.href = "login.html";
    return;
  }

  uid = user.uid;
  const commerceRef = doc(db, "commerces", uid);
  const commerceSnap = await getDoc(commerceRef);

  if(!commerceSnap.exists()){
    // connectÃ© mais pas commerÃ§ant
    await signOut(auth);
    alert("AccÃ¨s refusÃ©");
    window.location.href = "index.html";
    return;
  }

  // âœ… commerÃ§ant autorisÃ©
  loadProducts();
  loadOrders();
});

// Logout
document.getElementById("logout").onclick = () =>
  signOut(auth).then(()=> window.location.href="login.html");

// Ajouter produit
document.getElementById("addProductForm").addEventListener("submit", async e=>{
  e.preventDefault();

  const name = productName.value;
  const price = productPrice.value.replace(",", ".");
  const stock = parseInt(productStock.value);
  const imageFile = productImage.files[0];

  if(!imageFile){
    alert("Image obligatoire");
    return;
  }

  // 1ï¸âƒ£ upload image
  const imageRef = ref(
    storage,
    `produits/${uid}/${Date.now()}_${imageFile.name}`
  );

  await uploadBytes(imageRef, imageFile);
  const imageUrl = await getDownloadURL(imageRef);

  // 2ï¸âƒ£ crÃ©ation produit
  await addDoc(collection(db,"commerces",uid,"produits"),{
    name,
    price,
    stock,
    available: stock > 0,
    imageUrl,
    maxPerDelivery: 0,   // âˆ par dÃ©faut
  });

  e.target.reset();
});

// Modifier stock
async function updateStock(productId, currentStock, delta){
  const newStock = Math.max(0, currentStock + delta);
  await updateDoc(doc(db,"commerces",uid,"produits",productId),{
    stock: newStock,
    available: newStock > 0
  });
}


// Modifier max par client
window.updateMaxPerClient = async function(productId, value){
  const max = Math.max(0, parseInt(value) || 0);

  await updateDoc(
    doc(db,"commerces",uid,"produits",productId),
    { maxPerDelivery: max }
  );
};

// Affichage produits
function loadProducts(){
  onSnapshot(collection(db,"commerces",uid,"produits"), snapshot=>{
    productList.innerHTML="";
    snapshot.forEach(docSnap=>{
      const p = docSnap.data();
      const div = document.createElement("div");
      div.className="productCard";
      div.innerHTML=`
  ${p.imageUrl ? `<img src="${p.imageUrl}" style="width:100%;border-radius:10px;margin-bottom:10px;">` : ""}
  <h3>${p.name}</h3>
  <p>Prix : ${p.price} â‚¬</p>
  <p>Stock restant : <strong>${p.stock}</strong></p>

  <div class="stockControls">
    <button onclick="updateStock('${docSnap.id}', ${p.stock}, -1)">â–</button>
    <button onclick="updateStock('${docSnap.id}', ${p.stock}, 1)">â•</button>
  </div>

  <label>Max par client :</label>
  <input type="number"
         min="0"
         value="${p.maxPerDelivery ?? 0}"
         onchange="updateMaxPerClient('${docSnap.id}', this.value)">

  <p class="${p.available ? '' : 'unavailable'}">
    ${p.available ? 'Disponible' : 'Indisponible'}
  </p>

  <button onclick="deleteProduct('${docSnap.id}')">Supprimer</button>
`;
      productList.appendChild(div);
    });
  });
}

window.updateStock = updateStock;

window.deleteProduct = async id => {
  if(confirm("Supprimer ce produit ?")){
    await deleteDoc(doc(db,"commerces",uid,"produits",id));
  }
};

function loadOrders(){
  const ordersList = document.getElementById("ordersList");
  const ordersHistory = document.getElementById("ordersHistory");

  const q = query(
    collection(db,"commandes"),
    where("commerceId","==",uid)
  );

  onSnapshot(q, snapshot=>{
    // reset UI
    ordersList.innerHTML = "";
    ordersHistory.innerHTML = "";

    snapshot.docs
     .reverse()
     .forEach(docSnap=>{
       const o = docSnap.data();

      const div = document.createElement("div");
      div.className = "productCard";
      div.dataset.status = o.status;

      let action = "";

      if(o.status === "en_attente"){
  action = `
    <button onclick="markReady('${docSnap.id}')">Marquer prÃªte</button>
    <button style="background:#ff595e;margin-left:8px"
      onclick="cancelOrder('${docSnap.id}')">
      Annuler
    </button>
  `;
}
      else if(o.status === "prete"){
        action = `<em>En attente de livreur</em>`;
      }
      else if(o.status === "en_livraison"){
        action = `<em>Livreur en route</em>`;
      }
      else{
        action = `<em>Commande terminÃ©e</em>`;
      }

      div.innerHTML = `
        <strong>Commande</strong><br>
        ${o.client.nom}<br>
        Total : ${o.total.toFixed(2)} â‚¬<br>
        Statut : <strong>${statusLabel(o.status)}</strong><br><br>
        ${action}
      `;

      // ğŸ”½ ICI EST LA LOGIQUE IMPORTANTE
      if(o.status === "livree"){
        ordersHistory.appendChild(div); // historique
      }else{
        ordersList.appendChild(div); // en cours
      }
    });
  });
}
window.markReady = async function(orderId){
  const ref = doc(db,"commandes",orderId);
  const snap = await getDoc(ref);

  if(!snap.exists()) return;

  const data = snap.data();

  if(data.commerceId !== uid || data.status !== "en_attente"){
    alert("Action interdite");
    return;
  }

  await updateDoc(ref,{
    status: "prete"
  });
}

window.cancelOrder = async function(orderId){
  if(!confirm("Annuler cette commande ? Le client sera remboursÃ©.")) return;

  const ref = doc(db,"commandes",orderId);
  const snap = await getDoc(ref);

  if(!snap.exists()) return;

  const data = snap.data();

  if(data.commerceId !== uid || data.status !== "en_attente"){
    alert("Action interdite");
    return;
  }

  await updateDoc(ref,{
    status: "annulee",
    cancelledAt: new Date()
  });
}

function statusLabel(status){
  switch(status){
    case "en_attente": return "ğŸ•“ En attente";
    case "prete": return "ğŸŸ  PrÃªte (attente livreur)";
    case "en_livraison": return "ğŸŸ£ En livraison";
    case "livree": return "ğŸŸ¢ LivrÃ©e";
    function statusLabel(status){
  switch(status){
    case "en_attente": return "ğŸ•“ En attente";
    case "prete": return "ğŸŸ  PrÃªte (attente livreur)";
    case "en_livraison": return "ğŸŸ£ En livraison";
    case "livree": return "ğŸŸ¢ LivrÃ©e";
    case "annulee": return "âŒ AnnulÃ©e";
    default: return status;
  }
}
    default: return status;
  }
}
</script>

</body>
</html>
