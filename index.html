<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Livraison Locale</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#fff;color:#333;min-height:100vh;overflow-x:hidden}
header{background:rgba(0,119,182,.9);backdrop-filter:blur(10px);color:white;padding:2rem 1rem;border-radius:0 0 20px 20px;box-shadow:0 8px 30px rgba(0,0,0,.15)}
#cta{margin-top:1rem;display:flex;gap:1rem}
#cta button{flex:1;padding:.9rem;border:none;border-radius:14px;font-size:1rem;font-weight:600;cursor:pointer}
#orderBtn{background:linear-gradient(135deg,#00b4d8,#0077b6);color:white}
#menuBtn{background:rgba(255,255,255,.2);color:white}
#mobileMenu,#mobileMenuOverlay{display:none}
#mobileMenu{position:fixed;top:0;left:0;right:0;bottom:0;background:white;z-index:999;padding:2rem}
#mobileMenu a{display:block;padding:1rem 0;font-size:1.2rem;font-weight:600;color:#0077b6;border-bottom:1px solid #eee}
#mobileMenuOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.3);z-index:998}
section{padding:1.5rem 1rem;max-width:900px;margin:auto}
#categoryList,#commerceList,#productList{display:grid;grid-template-columns:1fr;gap:1rem}
.category,.commerce,.product{background:#fff;padding:1rem;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.05)}
.product span{display:block;font-weight:600}
.stock{font-size:.85rem;color:#666;margin:.3rem 0}
.product button{width:100%;padding:.7rem;border:none;border-radius:12px;background:#0077b6;color:white;font-weight:600;cursor:pointer}
.product button:disabled{background:#ccc}
#cart{position:fixed;bottom:1rem;left:1rem;right:1rem;background:white;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,.15);max-height:90px;overflow:hidden;transition:.3s;z-index:500}
#cart.expanded{max-height:340px}
#cartHeader{display:flex;justify-content:space-between;padding:1rem;cursor:pointer}
#cartContent{padding:0 1rem}
#cartContent div{margin-bottom:.6rem}
.cart-btn{padding:.4rem .7rem;border:none;border-radius:8px;background:#0077b6;color:white;cursor:pointer}
.clear-btn{width:100%;background:#ff595e;color:white;border:none;padding:.7rem;border-radius:12px;margin-top:0.5rem}
#addedMessage,#errorMessage{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:1rem 2rem;border-radius:12px;color:white;font-weight:600;display:none;z-index:1000}
#addedMessage{background:#4caf50}
#errorMessage{background:#d00000}

/* Modal Checkout */
#checkoutModal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;justify-content:center;align-items:center}
#checkoutModal > div{background:white;padding:2rem;border-radius:20px;max-width:400px;width:90%}
#checkoutModal input{width:100%;margin-bottom:0.5rem;padding:0.5rem;border-radius:8px;border:1px solid #ccc}
#checkoutModal button{width:100%;padding:0.7rem;border:none;border-radius:12px;font-weight:600;cursor:pointer;margin-top:0.5rem}
#checkoutModal button[type="submit"]{background:#00b4d8;color:white}
#checkoutModal button.cancel{background:#ff595e;color:white}
</style>
</head>
<body>

<header>
  <h1>Livraison Locale</h1>
  <p>Commerces des Sables dâ€™Olonne</p>
  <div id="cta">
    <button id="orderBtn" onclick="showPage('commander')">Commander</button>
    <button id="menuBtn" onclick="toggleMenu()">Menu</button>
  </div>
</header>

<div id="mobileMenuOverlay" onclick="toggleMenu()"></div>
<div id="mobileMenu">
  <a onclick="nav('accueil')">Accueil</a>
  <a onclick="nav('apropos')">Ã€ propos</a>
  <a onclick="nav('contact')">Contact</a>
  <a href="inscription.html">Nous rejoindre</a>
</div>

<section id="accueil">
<h2>Bienvenue</h2>
<p>Commandez local, simplement.</p>
</section>

<section id="apropos" style="display:none">
<h2>Ã€ propos</h2>
<p>Plateforme locale de livraison.</p>
</section>

<section id="contact" style="display:none">
<h2>Contact</h2>
<p>cedric.huet.pro@gmail.com</p>
</section>

<section id="commander" style="display:none">
<h2>Choisir une catÃ©gorie</h2>
<div id="categoryList"></div>
<div id="commerceList"></div>
<div id="productList"></div>
</section>

<div id="cart">
  <div id="cartHeader">
    <strong>ðŸ›’ Panier</strong>
    <span id="toggleCart">â–²</span>
  </div>
  <div id="cartContent"></div>
  <button class="clear-btn" onclick="clearCart()">Vider le panier</button>
  <button class="clear-btn" id="checkoutBtn">Valider la commande</button>
</div>

<!-- Modal Checkout -->
<div id="checkoutModal">
  <div>
    <h2>Finaliser la commande</h2>
    <form id="checkoutForm">
      <input type="text" name="name" placeholder="Nom & prÃ©nom" required>
      <input type="email" name="email" placeholder="Email" required>
      <input type="text" name="address" placeholder="Adresse complÃ¨te" required>
      <input type="tel" name="phone" placeholder="TÃ©lÃ©phone" required>
      <button type="submit">Payer</button>
      <button type="button" class="cancel" onclick="closeCheckout()">Annuler</button>
    </form>
  </div>
</div>

<div id="addedMessage">Produit ajoutÃ© âœ…</div>
<div id="errorMessage"></div>

<script src="https://js.stripe.com/v3/"></script>

<script>
// MENU
function toggleMenu(){const m=document.getElementById("mobileMenu");const o=document.getElementById("mobileMenuOverlay");const open=m.style.display==="block";m.style.display=open?"none":"block";o.style.display=open?"none":"block";}
function nav(p){toggleMenu();showPage(p);}
function showPage(p){["accueil","apropos","contact","commander"].forEach(id=>document.getElementById(id).style.display="none");document.getElementById(p).style.display="block";}

// PANIER
let selectedCommerceId=null;
function getCart(){return JSON.parse(localStorage.getItem("panier"))||[];}
function saveCart(c){localStorage.setItem("panier",JSON.stringify(c));renderCart();}
function clearCart(){localStorage.removeItem("panier");selectedCommerceId=null;renderCart();}
function showMessage(id,msg){const el=document.getElementById(id);el.innerText=msg;el.style.display="block";setTimeout(()=>el.style.display="none",2000);}
function addToCart(commerceId,productId,name,price,stock){
  if(selectedCommerceId && selectedCommerceId!==commerceId){showMessage("errorMessage","Vous ne pouvez commander qu'un seul magasin Ã  la fois");return;}
  selectedCommerceId=commerceId;
  let cart=getCart();
  const item=cart.find(p=>p.productId===productId);
  if(item){if(item.quantity>=stock){showMessage("errorMessage","Stock limitÃ©");return;}item.quantity++;}
  else{if(stock<1){showMessage("errorMessage","Produit non disponible");return;}cart.push({commerceId,productId,name,price:parseFloat(price),quantity:1,stock});}
  saveCart(cart);showMessage("addedMessage","Produit ajoutÃ© âœ…");
}
function renderCart(){
  const container=document.getElementById("cartContent");const cart=getCart();container.innerHTML="";
  if(cart.length===0){container.innerHTML="<p>Panier vide</p>";return;}
  let total=0;
  cart.forEach(i=>{total+=i.price*i.quantity;container.innerHTML+=`<div><strong>${i.name}</strong><br>${i.price.toFixed(2).replace(".",",")} â‚¬<br><button class="cart-btn" onclick="changeQty('${i.productId}',-1)">-</button> ${i.quantity} <button class="cart-btn" onclick="changeQty('${i.productId}',1)">+</button></div>`;});
  container.innerHTML+=`<strong>Total : ${total.toFixed(2).replace(".",",")} â‚¬</strong>`;
}
function changeQty(id,delta){
  let cart=getCart();
  const item=cart.find(p=>p.productId===id);if(!item)return;
  if(delta>0 && item.quantity>=item.stock){showMessage("errorMessage","Stock limitÃ©");return;}
  item.quantity=Math.max(1,item.quantity+delta);
  saveCart(cart);
}
document.getElementById("cartHeader").onclick=()=>{document.getElementById("cart").classList.toggle("expanded");}
document.addEventListener("DOMContentLoaded",renderCart);

// Checkout Modal
function openCheckout(){document.getElementById("checkoutModal").style.display="flex";}
function closeCheckout(){document.getElementById("checkoutModal").style.display="none";}
document.getElementById("checkoutBtn").onclick=openCheckout;

// Stripe Checkout (Front-end)
const stripe = Stripe("TON_PUBLIC_KEY"); // <-- Ã  remplacer par ta clÃ© publique

document.getElementById("checkoutForm").onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const customer = {
    name: formData.get("name"),
    email: formData.get("email"),
    address: formData.get("address"),
    phone: formData.get("phone")
  };
  const cart = getCart();

  try{
    const res = await fetch("/create-checkout-session", { // <-- endpoint backend Firebase
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ cart, customer })
    });
    const data = await res.json();
    await stripe.redirectToCheckout({ sessionId: data.id });
  }catch(err){
    showMessage("errorMessage","Erreur paiement, rÃ©essayez");
  }
};
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, onSnapshot, doc, runTransaction, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",authDomain:"livraison-sablaise.firebaseapp.com",projectId:"livraison-sablaise",storageBucket:"livraison-sablaise.firebasestorage.app",messagingSenderId:"930839535214",appId:"1:930839535214:web:a3235919aa88d066bc507f"};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

// Pour tests, checkout direct (mais rÃ©el = via Stripe Webhook)
window.checkout=async()=>{
  const cart=getCart();
  if(cart.length===0) return;
  const commerceId=cart[0].commerceId;
  try{
    await runTransaction(db,async t=>{
      for(const item of cart){
        const ref=doc(db,"commerces",commerceId,"produits",item.productId);
        const snap=await t.get(ref);
        if(!snap.exists()) throw "Produit introuvable";
        if((snap.data().stock||0)<item.quantity) throw "Stock insuffisant";
        t.update(ref,{stock:(snap.data().stock||0)-item.quantity});
      }
      await addDoc(collection(db,"orders"),{
        commerceId,
        items:cart,
        total:cart.reduce((t,i)=>t+i.price*i.quantity,0),
        status:"pending",
        createdAt:serverTimestamp()
      });
    });
    clearCart();
    alert("Commande validÃ©e âœ…");
  }catch(e){alert(e);}
};
</script>

</body>
</html>
