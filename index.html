<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Livraison Locale</title>
<style>
/* RESET */
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background: #ffffff;
  color:#333;
  min-height:100vh;
  line-height:1.5;
  overflow-x:hidden;
  transition: background 0.3s ease-in-out;
}

/* HEADER */
header{
  background: rgba(0,119,182,0.9);
  backdrop-filter: blur(10px);
  color:white;
  padding:2rem 1rem;
  border-bottom-left-radius:20px;
  border-bottom-right-radius:20px;
  box-shadow:0 8px 30px rgba(0,0,0,0.15);
  position:sticky;
  top:0;
  z-index:100;
}
header h1{font-size:1.8rem;margin-bottom:.3rem}
header p{opacity:.9;font-size:.95rem}
#cta{margin-top:1rem;display:flex;gap:1rem}
#cta button{
  flex:1;padding:.9rem;border:none;border-radius:14px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;
}
#orderBtn{
  background: linear-gradient(135deg,#00b4d8,#0077b6);
  color:white;
}
#orderBtn:hover{
  transform:scale(1.05);
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
}
#menuBtn{
  background: rgba(255,255,255,.2);
  color:white;
}
#menuBtn:hover{
  background: rgba(255,255,255,.3);
  transform:scale(1.03);
}

/* MOBILE MENU */
#mobileMenu{
  display:none;background:white;position:fixed;top:0;left:0;right:0;bottom:0;
  z-index:999;padding:2rem;overflow-y:auto;box-shadow:0 0 20px rgba(0,0,0,0.2);
}
#mobileMenu a{
  display:block;padding:1rem 0;font-size:1.2rem;font-weight:600;color:#0077b6;
  border-bottom:1px solid #eee;cursor:pointer;
}
#mobileMenuOverlay{
  display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);
  z-index:998;
}

/* SECTIONS */
section{padding:1.5rem 1rem;max-width:900px;margin:auto}
h2{margin-bottom:1rem}

/* GRID LISTES */
#categoryList,#commerceList,#productList{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1.5rem;
}
.category,.commerce,.product{
  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(8px);
  padding:1rem;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,0.05);
  cursor:pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  margin-bottom: 1rem;
}
.category:hover,.commerce:hover,.product:hover{
  transform:translateY(-5px);
  box-shadow:0 15px 30px rgba(0,0,0,0.08);
}
.category.selected,.commerce.selected{background: rgba(0,180,216,0.3);}
.product span{font-weight:600;display:block}
.stock{font-size:.85rem;color:#666;margin:.3rem 0}
.product button{
  margin-top:.6rem;width:100%;padding:.7rem;border:none;border-radius:12px;
  background: linear-gradient(135deg,#00b4d8,#0077b6);
  color:white;font-weight:600;cursor:pointer;transition:all 0.3s ease;
}
.product button:hover:not(:disabled){
  transform:scale(1.05);
  box-shadow:0 5px 15px rgba(0,0,0,0.15);
}
.product button:disabled{background:#ccc;opacity:0.6;cursor:not-allowed}

/* MINI PANIER FLOTANT */
#cart{
  position: fixed;
  bottom: 1rem;
  left: 1rem;
  right: 1rem;
  z-index: 500;
  background: rgba(255,255,255,0.95);
  border-radius: 20px;
  max-height: 80px;
  overflow:hidden;
  padding:0.5rem 1rem;
  box-shadow: 0 15px 40px rgba(0,0,0,0.1);
  transition: max-height 0.3s ease, padding 0.3s ease;
}
#cart.expanded{max-height: 350px; padding:1rem;}
#cartHeader{
  display:flex; justify-content: space-between; align-items: center;
  cursor:pointer;
}
#cartContent{
  margin-top:0.5rem;
}
#cartContent div{
  padding:0.8rem;
  border-radius:12px;
  margin-bottom:0.5rem;
  background: rgba(224,247,250,0.7);
  box-shadow:0 6px 15px rgba(0,0,0,0.05);
  transition: transform 0.3s ease;
}
#cartContent div:hover{
  transform: translateY(-2px);
  box-shadow:0 10px 25px rgba(0,0,0,0.12);
}
#cart h3{text-align:right;color:#0077b6;margin-top:0.5rem;}
#cart button{margin:0.2rem; padding:0.4rem 0.7rem; border:none; border-radius:8px; cursor:pointer; background: linear-gradient(135deg,#00b4d8,#0077b6); color:white; font-weight:600; transition:all 0.3s ease;}
#cart button:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,0.15);}
#cart .clear-btn{
  width:100%;
  background:#ff595e;
  color:white;
  border:none;
  padding:0.7rem;
  border-radius:12px;
  cursor:pointer;
  font-weight:600;
  margin-top:0.5rem;
}

/* FORM CHECKOUT */
#checkoutForm input{
  width:100%;
  padding:.7rem;
  margin-bottom:.8rem;
  border-radius:12px;
  border:1px solid #ccc;
}
#checkoutForm button{
  width:100%;
  padding:.8rem;
  border:none;
  border-radius:12px;
  background: linear-gradient(135deg,#00b4d8,#0077b6);
  color:white;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s ease;
}
#checkoutForm button:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,0.15);}

/* MOBILE GRID */
@media(max-width:767px){
  #categoryList,#commerceList,#productList{
    grid-template-columns:1fr; gap:1.2rem;
  }
  section{padding-bottom:150px;}
}
</style>
</head>
<body>

<header>
<h1>Livraison Locale</h1>
<p>Commerces des Sables d‚ÄôOlonne</p>
<div id="cta">
  <button id="orderBtn" onclick="showPage('commander')">Commander</button>
  <button id="menuBtn" onclick="toggleMenu()">Menu</button>
</div>
</header>

<div id="mobileMenuOverlay" onclick="toggleMenu()"></div>
<div id="mobileMenu">
  <a onclick="nav('accueil')">Accueil</a>
  <a onclick="nav('apropos')">√Ä propos</a>
  <a onclick="nav('contact')">Contact</a>
  <a href="inscription.html">Nous rejoindre</a>
</div>

<section id="accueil">
<h2>Bienvenue</h2>
<p>Commandez local, simplement.</p>
</section>

<section id="apropos" style="display:none">
<h2>√Ä propos</h2>
<p>Plateforme locale de livraison.</p>
</section>

<section id="contact" style="display:none">
<h2>Contact</h2>
<p>cedric.huet.pro@gmail.com</p>
</section>

<section id="commander" style="display:none">
<h2>Choisir une cat√©gorie</h2>
<div id="categoryList"></div>
<div id="commerceList"></div>
<div id="productList"></div>
</section>

<!-- MINI-PANIER FLOTANT -->
<div id="cart">
  <div id="cartHeader">
    <strong>üõí Panier</strong>
    <span id="toggleCart">&#9650;</span>
  </div>
  <div id="cartContent"></div>
  <button class="clear-btn" onclick="clearCart()">Vider le panier</button>
</div>

<!-- FORMULAIRE CHECKOUT -->
<section id="checkout" style="max-width:800px;margin:20px auto">
<h2>‚úÖ Valider le panier</h2>
<form id="checkoutForm">
  <input type="text" id="clientFirstName" placeholder="Pr√©nom" required>
  <input type="text" id="clientLastName" placeholder="Nom" required>
  <input type="email" id="clientEmail" placeholder="Email" required>
  <input type="text" id="clientAddress" placeholder="Adresse" required>
  <input type="text" id="clientPhone" placeholder="T√©l√©phone" required>
  <button type="submit">Valider la commande</button>
</form>
</section>

<div id="errorMessage"></div>
<div id="addedMessage">Produit ajout√© ‚úÖ</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, onSnapshot, doc, getDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise",
  storageBucket: "livraison-sablaise.firebasestorage.app",
  messagingSenderId: "930839535214",
  appId: "1:930839535214:web:a3235919aa88d066bc507f",
  measurementId: "G-R3ZCGLQ69E"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// MENU
function toggleMenu(){const m=document.getElementById("mobileMenu");const o=document.getElementById("mobileMenuOverlay");const show=m.style.display==="block";m.style.display=show?"none":"block";o.style.display=show?"none":"block";}
function nav(p){toggleMenu(); showPage(p);}
function showPage(p){['accueil','apropos','contact','commander'].forEach(id=>document.getElementById(id).style.display='none'); document.getElementById(p).style.display='block';}

// MESSAGE
function showMessage(msg){const el=document.getElementById("errorMessage"); el.innerText=msg; el.classList.add("show"); setTimeout(()=>{el.classList.remove("show");},2000);}
function showAddedMessage(){const el=document.getElementById("addedMessage"); el.classList.add("show"); setTimeout(()=>{el.classList.remove("show");},1000);}

// PANIER
let selectedCommerceId=null;
function getCart(){return JSON.parse(localStorage.getItem("panier"))||[];}
function saveCart(cart){localStorage.setItem("panier",JSON.stringify(cart)); renderCart();}
function clearCart(){localStorage.removeItem("panier"); selectedCommerceId=null; renderCart();}
function addToCart(commerceId, productId, name, price, stock){
  if(selectedCommerceId && selectedCommerceId !== commerceId){showMessage("Vous ne pouvez commander qu'un seul magasin √† la fois");return;}
  selectedCommerceId = commerceId;
  let cart = getCart();
  price = parseFloat(price.toString().replace(",","."));  
  const existing = cart.find(p => p.productId === productId && p.commerceId === commerceId);
  if(existing){if(existing.quantity>=stock){showMessage("Stock limit√©"); return;} existing.quantity += 1;}
  else{if(stock<1){showMessage("Produit non disponible"); return;} cart.push({commerceId,productId,name,price,quantity:1,stock});}
  saveCart(cart); showAddedMessage();
}
function removeFromCart(productId){let cart=getCart(); cart=cart.filter(p=>p.productId!==productId); if(cart.length===0) selectedCommerceId=null; saveCart(cart);}
function updateQuantity(productId,qty){let cart=getCart(); const item=cart.find(p=>p.productId===productId); if(item){ if(qty>item.stock){ showMessage("Stock limit√©"); return;} item.quantity=Math.max(1,qty);} saveCart(cart);}
function renderCart(){
  const container=document.getElementById("cartContent"); const cart=getCart(); container.innerHTML="";
  if(cart.length===0){container.innerHTML="<p>Panier vide</p>"; return;}
  let total=0;
  cart.forEach(item=>{total+=item.price*item.quantity; container.innerHTML+=`
  <div>
    <strong>${item.name}</strong> ‚Äì ${item.price.toFixed(2).replace(".",",")}‚Ç¨<br>
    Quantit√©:
    <button onclick="updateQuantity('${item.productId}', ${item.quantity-1})">-</button>
    ${item.quantity}
    <button onclick="updateQuantity('${item.productId}', ${item.quantity+1})">+</button>
    <br>
    <button onclick="removeFromCart('${item.productId}')">Supprimer</button>
  </div>`;});
  container.innerHTML+=`<h3>Total : ${total.toFixed(2).replace(".",",")} ‚Ç¨</h3>`;
}
document.addEventListener("DOMContentLoaded", renderCart);
document.getElementById("cartHeader").onclick=()=>{const cart=document.getElementById("cart");cart.classList.toggle("expanded"); const arrow=document.getElementById("toggleCart"); arrow.innerHTML=cart.classList.contains("expanded")?"&#9660;":"&#9650;";};

// FIRESTORE COMMERCE / PRODUITS
const categoryList=document.getElementById("categoryList");
const commerceList=document.getElementById("commerceList");
const productList=document.getElementById("productList");

let categoriesSet = new Set();
let commerceCategories = {};

async function loadCategories(){
  const snapshot = await getDocs(collection(db,"commerces"));
  snapshot.forEach(docSnap=>{
    const c=docSnap.data();
    const cat=c.category || "Autres";
    categoriesSet.add(cat);
    commerceCategories[docSnap.id]=cat;
  });
  categoryList.innerHTML="";
  [...categoriesSet].sort().forEach(cat=>{
    const div=document.createElement("div");
    div.className="category";
    div.dataset.opened="false";
    div.innerHTML=`${cat} <span style="float:right;cursor:pointer">&#9654;</span>`;
    div.onclick=()=>{
      if(div.dataset.opened==="true"){ commerceList.innerHTML=""; productList.innerHTML=""; div.dataset.opened="false"; div.classList.remove("selected"); return;}
      [...categoryList.children].forEach(c=>{c.dataset.opened="false"; c.classList.remove("selected");});
      div.dataset.opened="true"; div.classList.add("selected");
      showCommercesByCategory(cat);
    };
    categoryList.appendChild(div);
  });
}

function showCommercesByCategory(cat){
  productList.innerHTML="";
  commerceList.innerHTML="<h3>Commerces</h3>";
  getDocs(collection(db,"commerces")).then(snapshot=>{
    snapshot.forEach(docSnap=>{
      if((docSnap.data().category || "Autres")===cat){
        const div=document.createElement("div");
        div.className="commerce";
        div.dataset.opened="false";
        div.innerHTML=`${docSnap.data().name} <span style="float:right;cursor:pointer">&#9660;</span>`;
        div.onclick=()=>{
          if(div.dataset.opened==="true"){ productList.innerHTML=""; div.dataset.opened="false"; div.classList.remove("selected"); return; }
          [...commerceList.children].forEach(c=>{c.dataset.opened="false"; c.classList.remove("selected");});
          div.dataset.opened="true"; div.classList.add("selected");
          showProducts(docSnap.id);
        };
        commerceList.appendChild(div);
      }
    });
  });
  productList.innerHTML="";
}

function showProducts(commerceId){
  productList.innerHTML="<h3>Produits</h3>";
  const productsRef=collection(db,"commerces",commerceId,"produits");
  onSnapshot(productsRef,snapshot=>{
    productList.innerHTML="<h3>Produits</h3>";
    snapshot.forEach(docSnap=>{
      const p=docSnap.data();
      const stock = p.stock || 10;
      const div=document.createElement("div");
      div.className="product";
      const price=p.price.toString().replace(".",",");
      div.innerHTML=`<span>${p.name} - ${price}‚Ç¨</span><span class="stock">Stock : ${stock}</span>`;
      const btn=document.createElement("button");
      btn.innerText="Ajouter au panier";
      btn.disabled=!p.available || stock<1;
      btn.onclick=()=>addToCart(commerceId,docSnap.id,p.name,p.price,stock);
      div.appendChild(btn);
      productList.appendChild(div);
    });
  });
}

loadCategories();

// CHECKOUT FORM
document.getElementById("checkoutForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const cart=getCart();
  if(cart.length===0){showMessage("Le panier est vide !"); return;}

  const firstName=document.getElementById("clientFirstName").value.trim();
  const lastName=document.getElementById("clientLastName").value.trim();
  const email=document.getElementById("clientEmail").value.trim();
  const address=document.getElementById("clientAddress").value.trim();
  const phone=document.getElementById("clientPhone").value.trim();

  // V√©rifier le stock en temps r√©el
  let stockOk=true;
  for(const item of cart){
    const docRef=doc(db,"commerces",item.commerceId,"produits",item.productId);
    const docSnap=await getDoc(docRef);
    if(!docSnap.exists()){showMessage(`Produit ${item.name} non trouv√©.`); stockOk=false; break;}
    const stock=docSnap.data().stock || 0;
    if(item.quantity>stock){showMessage(`Stock insuffisant pour ${item.name}`); stockOk=false; break;}
  }
  if(!stockOk) return;

  // Cr√©er commande Firestore
  try{
    await addDoc(collection(db,"commandes"),{
      client:{firstName,lastName,email,address,phone},
      items:cart,
      createdAt:new Date()
    });

    // D√©cr√©menter stock
    for(const item of cart){
      const docRef=doc(db,"commerces",item.commerceId,"produits",item.productId);
      const docSnap=await getDoc(docRef);
      const newStock=(docSnap.data().stock||0)-item.quantity;
      await updateDoc(docRef,{stock:newStock});
    }

    alert("Commande valid√©e ! Merci.");
    clearCart();
    document.getElementById("checkoutForm").reset();
  }catch(err){
    console.error(err);
    showMessage("Erreur lors de la validation, r√©essayez.");
  }
});
</script>

</body>
</html>
