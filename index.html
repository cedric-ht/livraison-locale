<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Terroir Sables - Livraison Express</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background:#F5F1E8;
  color:#2C2C2C;
  min-height:100vh;
  line-height:1.6;
  overflow-x:hidden;
  transition: background 0.3s ease-in-out;
}

h1, h2, h3 {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
color: #2C2C2C;
}

header{
background: linear-gradient(135deg, #6B2C3E, #8B4C5E);
color:white;
padding:2.5rem 1.5rem;
border-bottom-left-radius:24px;
border-bottom-right-radius:24px;
box-shadow:0 10px 35px rgba(107, 44, 62, 0.25);
position:relative;
}
header h1{
font-size:1.6rem;
margin-bottom:.5rem;
font-weight:700;
letter-spacing:-0.5px;
}
header p{
opacity:.92;
font-size:.95rem;
font-weight:400;
}
#cta{
margin-top:1.5rem;
display:flex;
gap:1rem;
}
#cta button{
flex:1;
padding:1rem;
border:none;
border-radius:16px;
font-size:1rem;
font-weight:700;
cursor:pointer;
transition:all 0.3s ease;
font-family:‚ÄòInter‚Äô, sans-serif;
}
#orderBtn{
background: linear-gradient(135deg, #8B9D83, #A4B89C);
color:white;
box-shadow:0 6px 20px rgba(139, 157, 131, 0.3);
}
#orderBtn:hover{
transform:translateY(-3px);
box-shadow:0 10px 30px rgba(139, 157, 131, 0.4);
}
#menuBtn{
background: rgba(255,255,255,.25);
color:white;
backdrop-filter: blur(10px);
}
#menuBtn:hover{
background: rgba(255,255,255,.35);
transform:translateY(-2px);
}

#mobileMenu{
display:none;
background:#FEFEFE;
position:fixed;
top:0;left:0;right:0;bottom:0;
z-index:999;
padding:2.5rem;
overflow-y:auto;
box-shadow:0 0 30px rgba(0,0,0,0.15);
}
#mobileMenu a{
display:block;
padding:1.2rem 0;
font-size:1.15rem;
font-weight:600;
color:#6B2C3E;
border-bottom:1px solid #F5F1E8;
cursor:pointer;
transition: color 0.2s ease;
}
#mobileMenu a:hover{ color:#8B9D83; }
#mobileMenuOverlay{
display:none;
position:fixed;
top:0;left:0;right:0;bottom:0;
background:rgba(44, 44, 44, 0.5);
z-index:998;
}

section{
padding:2rem 1.5rem;
max-width:1000px;
margin:auto;
}
h2{
margin-bottom:1.5rem;
font-size:1.8rem;
color:#6B2C3E;
}

#categoryList,#commerceList,#productList{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
gap:1.8rem;
}
.category,.commerce,.product{
background: #FEFEFE;
padding:1.5rem;
border-radius:20px;
border: 2px solid #F5F1E8;
box-shadow:0 8px 20px rgba(107, 44, 62, 0.08);
cursor:pointer;
transition: all 0.3s ease;
margin-bottom: 1rem;
}
.category:hover,.commerce:hover,.product:hover{
transform:translateY(-6px);
box-shadow:0 15px 35px rgba(107, 44, 62, 0.15);
border-color:#8B9D83;
}
.category.selected,.commerce.selected{
background: rgba(139, 157, 131, 0.15);
border-color:#8B9D83;
}
.product span{
font-weight:600;
display:block;
color:#2C2C2C;
}
.product .product-description {
color:#6B6B6B;
font-size:0.88rem;
font-style:italic;
margin:0.4rem 0;
}
.stock{
font-size:.88rem;
color:#6B6B6B;
margin:.5rem 0;
}
.product button{
margin-top:.8rem;
width:100%;
padding:.85rem;
border:none;
border-radius:14px;
background: linear-gradient(135deg, #6B2C3E, #8B4C5E);
color:white;
font-weight:700;
cursor:pointer;
transition:all 0.3s ease;
family:‚ÄòInter‚Äô, sans-serif;
}
.product button:hover:not(:disabled){
transform:translateY(-3px);
box-shadow:0 8px 20px rgba(107, 44, 62, 0.3);
}
.product button:disabled{
background:#D0D0D0;
opacity:0.5;
cursor:not-allowed;
}

/* ZONE INFO */
.zone-info {
background: #FEFEFE;
border: 2px solid #F5F1E8;
border-radius: 16px;
padding: 1rem 1.5rem;
margin-bottom: 1.5rem;
font-size: 0.9rem;
color: #6B6B6B;
box-shadow: 0 4px 12px rgba(107, 44, 62, 0.06);
}

.zone-info strong { color: #6B2C3E; }

/* MINI PANIER */
#cart {
position: fixed;
bottom: 1.5rem;
left: 1.5rem;
right: 1.5rem;
z-index: 500;
background: rgba(254, 254, 254, 0.98);
border-radius: 24px;
height: auto;
max-height: 80vh;
padding: 1rem 1.5rem;
box-shadow: 0 20px 50px rgba(107, 44, 62, 0.2);
border: 2px solid #F5F1E8;
}
#cartHeader {
display:flex;
justify-content: space-between;
align-items: center;
cursor:pointer;
font-family: ‚ÄòPlayfair Display‚Äô, serif;
color: #6B2C3E;
font-weight:700;
}
#cartContent {
max-height: 45vh;
overflow-y: auto;
margin-top: 1rem;
}
#cart:not(.expanded) #cartContent,
#cart:not(.expanded) .clear-btn,
#cart:not(.expanded) .validate-btn { display: none; }

#cartContent div {
padding:1rem;
border-radius:16px;
margin-bottom:0.8rem;
background: rgba(245, 241, 232, 0.6);
box-shadow:0 4px 12px rgba(107, 44, 62, 0.06);
transition: transform 0.3s ease;
}
#cartContent div:hover {
transform: translateY(-3px);
box-shadow:0 8px 20px rgba(107, 44, 62, 0.12);
}
#cart h3 {
text-align:right;
color:#6B2C3E;
margin-top:0.8rem;
font-family: ‚ÄòPlayfair Display‚Äô, serif;
}
#cart button {
margin:0.3rem;
padding:0.5rem 0.9rem;
border:none;
border-radius:12px;
cursor:pointer;
background: linear-gradient(135deg, #6B2C3E, #8B4C5E);
color:white;
font-weight:700;
transition:all 0.3s ease;
font-family:‚ÄòInter‚Äô, sans-serif;
}
#cart button:hover { transform:scale(1.06); box-shadow:0 6px 18px rgba(107, 44, 62, 0.25); }
#cart .clear-btn {
width:100%;
background:#D64545;
padding:0.85rem;
border-radius:14px;
margin-top:0.8rem;
}
#cart .validate-btn {
width:100%;
background: linear-gradient(135deg, #8B9D83, #A4B89C);
padding:1rem;
border-radius:16px;
font-weight:700;
margin-top:0.8rem;
box-shadow:0 6px 20px rgba(139, 157, 131, 0.3);
}

/* FORMULAIRE LIVRAISON */
#checkoutForm{
display:none;
position:fixed;
top:50%;left:50%;
transform:translate(-50%,-50%);
background:#FEFEFE;
padding:2.5rem;
border-radius:24px;
box-shadow:0 15px 50px rgba(107, 44, 62, 0.3);
z-index:1001;
max-width:450px;
width:90%;
max-height:90vh;
overflow-y:auto;
}
#checkoutForm h3{
font-family: ‚ÄòPlayfair Display‚Äô, serif;
color:#6B2C3E;
margin-bottom:1.5rem;
}
#checkoutForm input{
width:100%;
padding:0.9rem;
margin-bottom:1rem;
border-radius:14px;
border:2px solid #F5F1E8;
font-family:‚ÄòInter‚Äô, sans-serif;
transition: border 0.2s ease;
}
#checkoutForm input:focus{ outline:none; border-color:#8B9D83; }
#checkoutForm button{
width:100%;
padding:1rem;
border:none;
border-radius:16px;
background: linear-gradient(135deg, #6B2C3E, #8B4C5E);
color:white;
font-weight:700;
cursor:pointer;
font-family:‚ÄòInter‚Äô, sans-serif;
transition: all 0.3s ease;
}
#checkoutForm button:hover{ transform:translateY(-3px); box-shadow:0 10px 30px rgba(107, 44, 62, 0.3); }
#checkoutOverlay{
display:none;
position:fixed;
top:0;left:0;right:0;bottom:0;
background:rgba(44, 44, 44, 0.5);
z-index:1000;
}

#addedMessage,#errorMessage{
position: fixed;
top:50%;left:50%;
transform:translate(-50%,-50%);
padding:1.2rem 2.5rem;
border-radius:16px;
font-weight:700;
font-size:1.05rem;
display:none;
z-index:1001;
box-shadow:0 10px 30px rgba(0,0,0,.25);
text-align:center;
opacity:0;
transition:opacity 0.3s ease, transform 0.3s ease;
font-family:‚ÄòInter‚Äô, sans-serif;
}
#addedMessage{ background:#8B9D83; color:white; }
#errorMessage{ background:#D64545; color:white; }
#addedMessage.show,#errorMessage.show{
display:block;
opacity:1;
transform:translate(-50%,-50%) scale(1.05);
}

@media(max-width:767px){
#categoryList,#commerceList,#productList{ grid-template-columns:1fr; gap:1.3rem; }
section{ padding-bottom:140px; }
header h1{ font-size:1.4rem; }
}

#authBox {
background: linear-gradient(135deg, #6B2C3E, #8B4C5E);
color: #fff;
box-shadow: 0 15px 40px rgba(107, 44, 62, 0.3);
padding: 2.5rem;
border-radius: 24px;
transition: transform 0.3s ease, box-shadow 0.3s ease;
}
#authBox h3 {
text-align: center;
margin-bottom: 1.5rem;
font-size: 1.6rem;
font-family: ‚ÄòPlayfair Display‚Äô, serif;
color: white;
}
#authBox input {
border: none;
border-radius: 14px;
margin-bottom: 1.2rem;
padding: 1rem;
font-size: 1rem;
width: 100%;
font-family:‚ÄòInter‚Äô, sans-serif;
}
#authBox input:focus{ outline: none; box-shadow: 0 0 12px rgba(255,255,255,0.6); }
#authBox button {
width: 100%;
padding: 1rem;
margin-top: 0.6rem;
border-radius: 16px;
font-weight: 700;
cursor: pointer;
border: none;
transition: transform 0.2s ease, box-shadow 0.2s ease;
font-family:‚ÄòInter‚Äô, sans-serif;
}
#authBox button:hover{ transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
#authBox button:nth-child(3){ background: #8B9D83; color: #fff; }
#authBox button:nth-child(4){ background: #FEFEFE; color: #6B2C3E; font-weight: 700; }

.status-bar{ display:flex; gap:8px; margin-top:10px; }
.status-step{ flex:1; height:10px; border-radius:8px; background:#E5E5E5; }
.status-step.active{ background:#8B9D83; }

.productImg{
width:100%;
height:180px;
object-fit:cover;
border-radius:16px;
margin-bottom:0.8rem;
box-shadow:0 6px 15px rgba(107, 44, 62, 0.1);
}

#addressSuggestions {
background:#FEFEFE;
border:2px solid #F5F1E8;
border-radius:14px;
display:none;
max-height:180px;
overflow-y:auto;
margin-bottom:1rem;
}

/* PANIER MINIMUM BADGE */
.panier-min-badge {
display: inline-block;
background: rgba(139, 157, 131, 0.15);
color: #8B9D83;
border: 1px solid #8B9D83;
border-radius: 20px;
padding: 0.2rem 0.8rem;
font-size: 0.8rem;
font-weight: 600;
margin-top: 0.5rem;
}

/* ========================================== */
/* MODIFICATION 2: CSS CHECKBOX ALCOOL */
/* ========================================== */
.alcohol-consent {
display: flex;
align-items: flex-start;
gap: 0.8rem;
margin: 1.2rem 0;
padding: 1rem 1.2rem;
background: rgba(214,69,69,0.08);
border: 1.5px solid rgba(214,69,69,0.25);
border-radius: 14px;
}
.alcohol-consent input[type=‚Äúcheckbox‚Äù] {
width: auto !important;
margin: 0.3rem 0 0 0 !important;
cursor: pointer;
flex-shrink: 0;
}
.alcohol-consent label {
font-size: 0.85rem;
color: #2C2C2C;
line-height: 1.6;
cursor: pointer;
margin: 0;
}
.alcohol-consent label strong { color: #D64545; font-weight: 700; }
.alcohol-consent .warning {
display: block;
margin-top: 0.5rem;
font-size: 0.78rem;
color: #D64545;
font-weight: 600;
}
</style>

</head>
<body>

<header>
  <h1>üá´üá∑ Terroir Sables</h1>
  <p>Vin, Fromage & Pain livr√©s en 30 minutes üö¥</p>
  <div id="cta">
    <button id="orderBtn" onclick="showPage('commander')">Commander</button>
    <button id="menuBtn" onclick="toggleMenu()">Menu</button>
  </div>
</header>

<div id="mobileMenuOverlay" onclick="toggleMenu()"></div>
<div id="mobileMenu">
  <a onclick="nav('accueil')">Accueil</a>
  <a onclick="nav('apropos')">√Ä propos</a>
  <a onclick="nav('contact')">Contact</a>
  <a href="inscription.html">Nous rejoindre</a>
  <a onclick="nav('mesCommandes')">Mes commandes</a>
  <a id="menuLoginBtn" onclick="openLoginMenu()">Connexion</a>
  <a id="menuLogoutBtn" onclick="logout()" style="display:none">D√©connexion</a>
</div>

<div id="authBox" style="display:none; padding:2rem; max-width:450px; margin:auto;">
  <h3>Connexion</h3>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Mot de passe">
  <button onclick="login()">Se connecter</button>
  <button onclick="register()">Cr√©er un compte</button>
</div>

<section id="accueil">
  <h2>Bienvenue</h2>
  <p>D√©couvrez le meilleur du terroir fran√ßais, livr√© chez vous en 30 minutes. Vins artisanaux, fromages affin√©s et pains frais des Sables d'Olonne.</p>
</section>

<section id="apropos" style="display:none">
  <h2>√Ä propos</h2>
  <p>Terroir Sables valorise les producteurs locaux en livrant leurs meilleurs produits directement chez vous. Une plateforme locale, authentique et rapide.</p>
</section>

<section id="contact" style="display:none">
  <h2>Contact</h2>
  <p>üìß <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fa999f9e889399d4928f9f8ed48a8895ba9d979b9396d4999597">[email&#160;protected]</a></p>
</section>

<section id="commander" style="display:none">

  <!-- INFO ZONE ET TARIFS -->

  <div class="zone-info">
    üö¥ <strong>Livraison √† v√©lo</strong> ‚Äî Zone : <strong>5 km max</strong><br>
    üí∞ <strong>0 √† 3 km : 3,49 ‚Ç¨</strong> &nbsp;|&nbsp; <strong>3 √† 5 km : 4,49 ‚Ç¨</strong><br>
    üõí Panier minimum : <strong>10 ‚Ç¨</strong>
  </div>

  <h2>Choisir une cat√©gorie</h2>
  <div id="categoryList"></div>
  <div id="commerceList"></div>
  <div id="productList"></div>
</section>

<section id="mesCommandes" style="display:none">
  <h2>Mes commandes</h2>
  <div id="ordersClient"></div>
</section>

<!-- MINI PANIER FLOTANT -->

<div id="cart">
  <div id="cartHeader">
    <strong>üõí Panier</strong>
    <span id="toggleCart">&#9650;</span>
  </div>
  <div id="cartContent"></div>
  <div id="cartTotals"></div>
  <button class="clear-btn" onclick="clearCart()">Vider le panier</button>
  <button class="validate-btn" onclick="openCheckoutForm()">Valider la commande</button>
</div>

<!-- FORM LIVRAISON -->

<div id="checkoutOverlay" onclick="closeCheckoutForm()"></div>
<div id="checkoutForm">
  <h3>üö¥ Informations de livraison</h3>
  <input type="text" id="custName" placeholder="Nom et pr√©nom" required>
  <input type="text" id="custPhone" placeholder="T√©l√©phone" required>
  <input type="text" id="custAddress" placeholder="Adresse de livraison" required autocomplete="off">
  <div id="addressSuggestions"></div>
  <input type="text" id="custAddressExtra" placeholder="Compl√©ment d'adresse (b√¢timent, √©tage, digicode‚Ä¶)">
  <p id="deliveryPrice" style="margin-bottom:0.5rem;font-weight:600;color:#6B6B6B;"></p>
  <p id="deliveryTime" style="margin-bottom:0.5rem;font-size:0.9rem;color:#8B9D83;font-weight:600;"></p>
  <p id="checkoutTotal" style="font-weight:700;font-size:1.2rem;color:#6B2C3E;margin-bottom:1rem;"></p>

  <!-- ========================================== -->

  <!-- MODIFICATION 2: HTML CHECKBOX ALCOOL -->

  <!-- ========================================== -->

  <div id="alcoholConsent" style="display:none" class="alcohol-consent">
    <input type="checkbox" id="alcoholCheck">
    <label for="alcoholCheck">
      Je certifie avoir <strong>plus de 18 ans</strong> et √™tre majeur selon la loi de mon pays. 
      Je suis conscient(e) que la vente d'alcool aux mineurs est interdite.
      <span class="warning">‚ö†Ô∏è Une pi√®ce d'identit√© pourra vous √™tre demand√©e √† la livraison.</span>
    </label>
  </div>

<button onclick="confirmOrder()">Confirmer la commande</button>

</div>

<div id="errorMessage"></div>
<div id="addedMessage">Produit ajout√© ‚úÖ</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>

// ============================================
// CONSTANTES TARIFICATION
// ============================================
const ZONE_MAX_KM      = 5;
const TARIF_COURT      = 3.49; // 0-3km
const TARIF_LONG       = 4.49; // 3-5km
const PANIER_MINIMUM   = 10;

function getDeliveryPrice(distanceKm){
if(distanceKm > ZONE_MAX_KM) return null; // Hors zone
if(distanceKm <= 3) return TARIF_COURT;
return TARIF_LONG;
}

function getDeliveryTime(distanceKm){
if(distanceKm <= 3) return ‚Äú~20 min‚Äù;
return ‚Äú~30 min‚Äù;
}

// ============================================
// NAVIGATION
// ============================================
function toggleMenu(){
const m = document.getElementById(‚ÄúmobileMenu‚Äù);
const o = document.getElementById(‚ÄúmobileMenuOverlay‚Äù);
const show = m.style.display === ‚Äúblock‚Äù;
m.style.display = show ? ‚Äúnone‚Äù : ‚Äúblock‚Äù;
o.style.display = show ? ‚Äúnone‚Äù : ‚Äúblock‚Äù;
}

function nav(p){ toggleMenu(); showPage(p); }

function showPage(p){
[‚Äòaccueil‚Äô,‚Äòapropos‚Äô,‚Äòcontact‚Äô,‚Äòcommander‚Äô,‚ÄòmesCommandes‚Äô].forEach(id => {
const el = document.getElementById(id);
if(el) el.style.display = ‚Äònone‚Äô;
});
document.getElementById(p).style.display = ‚Äòblock‚Äô;
if(p === ‚ÄòmesCommandes‚Äô && window.renderClientOrders) window.renderClientOrders();
}

// ============================================
// MESSAGES
// ============================================
function showMessage(msg){
const el = document.getElementById(‚ÄúerrorMessage‚Äù);
el.innerText = msg;
el.classList.add(‚Äúshow‚Äù);
setTimeout(() => el.classList.remove(‚Äúshow‚Äù), 2500);
}

function showAddedMessage(){
const el = document.getElementById(‚ÄúaddedMessage‚Äù);
el.classList.add(‚Äúshow‚Äù);
setTimeout(() => el.classList.remove(‚Äúshow‚Äù), 1500);
}

// ============================================
// PANIER
// ============================================
let selectedCommerceId = null;

function getCart(){ return JSON.parse(localStorage.getItem(‚Äúpanier‚Äù)) || []; }
function saveCart(cart){ localStorage.setItem(‚Äúpanier‚Äù, JSON.stringify(cart)); renderCart(); }

function clearCart(){
localStorage.removeItem(‚Äúpanier‚Äù);
selectedCommerceId = null;
window.currentDeliveryPrice = null;
renderCart();
}

function addToCart(commerceId, productId, name, price, stock, maxPerDelivery){
// V√©rif commerce unique
if(selectedCommerceId && selectedCommerceId !== commerceId){
showMessage(‚ÄúVous ne pouvez commander que chez un seul commerce √† la fois‚Äù);
return;
}

selectedCommerceId = commerceId;
let cart = getCart();
price = parseFloat(price.toString().replace(‚Äù,‚Äù, ‚Äú.‚Äù));

const existing = cart.find(p => p.productId === productId && p.commerceId === commerceId);

if(existing){
if(maxPerDelivery > 0 && existing.quantity + 1 > maxPerDelivery){
showMessage(`Maximum ${maxPerDelivery} par commande`);
return;
}
if(existing.quantity >= stock){
showMessage(‚ÄúStock insuffisant‚Äù);
return;
}
existing.quantity += 1;
} else {
if(stock < 1){ showMessage(‚ÄúProduit non disponible‚Äù); return; }
cart.push({ commerceId, productId, name, price, quantity: 1, stock, maxPerDelivery });
}

saveCart(cart);
showAddedMessage();
}

function removeFromCart(productId){
let cart = getCart();
cart = cart.filter(p => p.productId !== productId);
if(cart.length === 0) selectedCommerceId = null;
saveCart(cart);
}

function updateQuantity(productId, qty){
let cart = getCart();
const index = cart.findIndex(p => p.productId === productId);
if(index === -1) return;

const item = cart[index];

if(qty > item.stock){ showMessage(‚ÄúStock insuffisant‚Äù); return; }

if(qty <= 0){
cart.splice(index, 1);
} else {
if(item.maxPerDelivery > 0 && qty > item.maxPerDelivery){
showMessage(`Maximum ${item.maxPerDelivery} par commande`);
return;
}
item.quantity = qty;
}

if(cart.length === 0) selectedCommerceId = null;
saveCart(cart);
}

function renderCart(){
const cartBox   = document.getElementById(‚Äúcart‚Äù);
const container = document.getElementById(‚ÄúcartContent‚Äù);
const cart      = getCart();

container.innerHTML = ‚Äú‚Äù;

if(cart.length === 0){
cartBox.classList.remove(‚Äúexpanded‚Äù);
container.innerHTML = ‚Äú<p style='color:#6B6B6B;font-style:italic;'>Panier vide</p>‚Äù;
return;
}

cartBox.classList.add(‚Äúexpanded‚Äù);

let itemsTotal = 0;

cart.forEach(item => {
itemsTotal += item.price * item.quantity;
container.innerHTML += `<div> <strong>${item.name}</strong> ‚Äî ${item.price.toFixed(2).replace(".", ",")}‚Ç¨<br> Qt√© : <button onclick="updateQuantity('${item.productId}', ${item.quantity - 1})">‚àí</button> <strong>${item.quantity}</strong> <button onclick="updateQuantity('${item.productId}', ${item.quantity + 1})">+</button> <button onclick="removeFromCart('${item.productId}')" style="background:#D64545;margin-left:0.5rem;">Suppr.</button> </div>`;
});

// V√©rif panier minimum
const panierOK = itemsTotal >= PANIER_MINIMUM;
const delivery = window.currentDeliveryPrice;

container.innerHTML += `<div style="background:transparent;box-shadow:none;padding:0.5rem 0;"> <h3 style="text-align:right;">Sous-total : ${itemsTotal.toFixed(2).replace(".", ",")} ‚Ç¨</h3> ${!panierOK ?`<p style="color:#D64545;font-size:0.85rem;text-align:right;">‚ö†Ô∏è Minimum ${PANIER_MINIMUM}‚Ç¨ requis</p>`: ""} <h3 style="text-align:right;">Livraison : ${delivery ? delivery.toFixed(2).replace(".", ",") + " ‚Ç¨" : "‚Äî"}</h3> <h3 style="text-align:right;">Total : ${(itemsTotal + (delivery || 0)).toFixed(2).replace(".", ",")} ‚Ç¨</h3> </div>`;
}

document.addEventListener(‚ÄúDOMContentLoaded‚Äù, renderCart);

// TOGGLE PANIER
const cartHeader = document.getElementById(‚ÄúcartHeader‚Äù);
if(cartHeader){
cartHeader.onclick = () => {
const cart  = document.getElementById(‚Äúcart‚Äù);
const arrow = document.getElementById(‚ÄútoggleCart‚Äù);
cart.classList.toggle(‚Äúexpanded‚Äù);
arrow.innerHTML = cart.classList.contains(‚Äúexpanded‚Äù) ? ‚Äú‚ñº‚Äù : ‚Äú‚ñ≤‚Äù;
}
}

// ============================================
// FORMULAIRE LIVRAISON
// ============================================
// ==========================================
// MODIFICATION 2: openCheckoutForm ASYNC + v√©rif alcool
// ==========================================
async function openCheckoutForm(){
const cart = getCart();
if(cart.length === 0){ showMessage(‚ÄúPanier vide‚Äù); return; }

const itemsTotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
if(itemsTotal < PANIER_MINIMUM){
showMessage(`Minimum ${PANIER_MINIMUM}‚Ç¨ requis pour commander`);
return;
}

// V√©rifier si le commerce vend de l‚Äôalcool
if(cart.length > 0){
const commerceSnap = await window.getDoc(window.doc(window.db, ‚Äúcommerces‚Äù, cart[0].commerceId));
if(commerceSnap.exists() && commerceSnap.data().venteAlcool === true){
document.getElementById(‚ÄúalcoholConsent‚Äù).style.display = ‚Äúflex‚Äù;
window.commerceVendAlcool = true;
} else {
document.getElementById(‚ÄúalcoholConsent‚Äù).style.display = ‚Äúnone‚Äù;
window.commerceVendAlcool = false;
}
}

document.getElementById(‚ÄúcheckoutForm‚Äù).style.display = ‚Äúblock‚Äù;
document.getElementById(‚ÄúcheckoutOverlay‚Äù).style.display = ‚Äúblock‚Äù;
}

function closeCheckoutForm(){
document.getElementById(‚ÄúcheckoutForm‚Äù).style.display = ‚Äúnone‚Äù;
document.getElementById(‚ÄúcheckoutOverlay‚Äù).style.display = ‚Äúnone‚Äù;
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  onSnapshot,
  doc,
  setDoc,
  getDoc,
  addDoc,
  serverTimestamp,
  query,
  where
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise",
  storageBucket: "livraison-sablaise.firebasestorage.app",
  messagingSenderId: "930839535214",
  appId: "1:930839535214:web:a3235919aa88d066bc507f"
};

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const auth = getAuth(app);

// Exposer getDoc et doc pour utilisation hors module
window.getDoc = getDoc;
window.doc = doc;
window.db = db;

const categoryList = document.getElementById("categoryList");
const commerceList = document.getElementById("commerceList");
const productList  = document.getElementById("productList");

let unsubscribeProducts = null;
let categoriesSet       = new Set();
let commerceCategories  = {};

// ============================================
// CAT√âGORIES
// ============================================
async function loadCategories(){
  const snapshot = await getDocs(collection(db, "commerces"));
  snapshot.forEach(docSnap => {
    const c   = docSnap.data();
    const cat = c.category || "Autres";
    categoriesSet.add(cat);
    commerceCategories[docSnap.id] = cat;
  });

  categoryList.innerHTML = "";
  [...categoriesSet].sort().forEach(cat => {
    const div = document.createElement("div");
    div.className       = "category";
    div.dataset.opened  = "false";
    div.innerHTML       = `${cat} <span style="float:right">‚ñ∂</span>`;

    div.onclick = () => {
      if(div.dataset.opened === "true"){
        commerceList.innerHTML = "";
        productList.innerHTML  = "";
        div.dataset.opened     = "false";
        div.classList.remove("selected");
        return;
      }
      [...categoryList.children].forEach(c => { c.dataset.opened = "false"; c.classList.remove("selected"); });
      div.dataset.opened = "true";
      div.classList.add("selected");
      showCommercesByCategory(cat);
    }
    categoryList.appendChild(div);
  });
}

// ============================================
// COMMERCES PAR CAT√âGORIE
// ============================================
function showCommercesByCategory(cat){
  productList.innerHTML  = "";
  commerceList.innerHTML = "<h3 style='grid-column:1/-1;color:#6B2C3E;margin-bottom:0.5rem;'>Commerces</h3>";

  getDocs(collection(db, "commerces")).then(snapshot => {
    snapshot.forEach(docSnap => {
      if((docSnap.data().category || "Autres") === cat){
        const div = document.createElement("div");
        div.className      = "commerce";
        div.dataset.opened = "false";
        div.innerHTML      = `${docSnap.data().name} <span style="float:right">‚ñº</span>`;

        div.onclick = () => {
          if(div.dataset.opened === "true"){
            productList.innerHTML  = "";
            div.dataset.opened     = "false";
            div.classList.remove("selected");
            return;
          }
          [...commerceList.children].forEach(c => { c.dataset.opened = "false"; c.classList.remove("selected"); });
          div.dataset.opened = "true";
          div.classList.add("selected");
          showProducts(docSnap.id);
        };
        commerceList.appendChild(div);
      }
    });
  });
}

// ============================================
// PRODUITS
// ============================================
function showProducts(commerceId){
  productList.innerHTML = "<h3 style='grid-column:1/-1;color:#6B2C3E;margin-bottom:0.5rem;'>Produits</h3>";

  if(unsubscribeProducts) unsubscribeProducts();

  unsubscribeProducts = onSnapshot(collection(db, "commerces", commerceId, "produits"), snapshot => {
    productList.innerHTML = "<h3 style='grid-column:1/-1;color:#6B2C3E;margin-bottom:0.5rem;'>Produits</h3>";

    snapshot.forEach(docSnap => {
      const p     = docSnap.data();
      const stock = p.stock || 0;
      const price = p.price.toString().replace(".", ",");

      const div       = document.createElement("div");
      div.className   = "product";
      div.innerHTML   = `
        ${p.imageUrl ? `<img src="${p.imageUrl}" class="productImg" alt="${p.name}">` : ""}
        <span>${p.name} ‚Äî ${price}‚Ç¨</span>
        ${p.description ? `<p class="product-description">${p.description}</p>` : ""}
        <span class="stock">üì¶ Stock : ${stock}</span>
        ${p.maxPerDelivery > 0 ? `<span class="panier-min-badge">Max ${p.maxPerDelivery}/commande</span>` : ""}
      `;

      const btn       = document.createElement("button");
      btn.innerText   = p.available && stock > 0 ? "Ajouter au panier" : "Indisponible";
      btn.disabled    = !p.available || stock < 1;

      btn.onclick = () => addToCart(
        commerceId,
        docSnap.id,
        p.name,
        p.price,
        stock,
        p.maxPerDelivery || 0
      );

      div.appendChild(btn);
      productList.appendChild(div);
    });
  });
}

// ============================================
// AUTOCOMPL√âTION ADRESSE
// ============================================
let selectedAddressLatLng = null;
let addressTimeout        = null;

document.getElementById("custAddress").addEventListener("input", e => {
  const q   = e.target.value.trim();
  const box = document.getElementById("addressSuggestions");

  selectedAddressLatLng = null;
  clearTimeout(addressTimeout);

  if(q.length < 3){ box.style.display = "none"; return; }

  addressTimeout = setTimeout(async () => {
    const apiKey = "42bb53accb9048248243b21b99a5a18a";
    const url    = `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(q)}&limit=5&lang=fr&filter=countrycode:fr&apiKey=${apiKey}`;
    const res    = await fetch(url);
    const data   = await res.json();

    box.innerHTML    = "";
    box.style.display = "block";

    if(!data.features || data.features.length === 0){ box.style.display = "none"; return; }

    data.features.forEach(f => {
      const div       = document.createElement("div");
      div.style.cssText = "padding:0.7rem;cursor:pointer;border-bottom:1px solid #F5F1E8;";
      div.innerText   = f.properties.formatted;

      div.onclick = async () => {
        document.getElementById("custAddress").value = f.properties.formatted;

        if(!f.properties.housenumber && !f.properties.street){
          showMessage("Veuillez choisir une adresse pr√©cise (rue + num√©ro)");
          return;
        }

        selectedAddressLatLng = {
          lat: f.geometry.coordinates[1],
          lng: f.geometry.coordinates[0]
        };

        const cart = getCart();
        if(cart.length === 0) return;

        const commerceSnap = await getDoc(doc(db, "commerces", cart[0].commerceId));
        if(!commerceSnap.exists()) return;

        const commerce = commerceSnap.data();
        const distance = getDistanceKm(
          commerce.lat, commerce.lng,
          selectedAddressLatLng.lat, selectedAddressLatLng.lng
        );

        // V√©rif zone 5km
        if(distance > ZONE_MAX_KM){
          showMessage(`‚ùå Adresse hors zone de livraison (${ZONE_MAX_KM} km max)`);
          document.getElementById("deliveryPrice").innerText = "";
          document.getElementById("checkoutTotal").innerText = "";
          document.getElementById("deliveryTime").innerText  = "";
          window.currentDeliveryPrice = null;
          renderCart();
          box.style.display = "none";
          return;
        }

        const deliveryPrice             = getDeliveryPrice(distance);
        window.currentDeliveryPrice     = deliveryPrice;
        renderCart();

        document.getElementById("deliveryPrice").innerText =
          `üö¥ Livraison : ${deliveryPrice.toFixed(2).replace(".", ",")} ‚Ç¨ (${distance.toFixed(1)} km)`;

        document.getElementById("deliveryTime").innerText =
          `‚è±Ô∏è D√©lai estim√© : ${getDeliveryTime(distance)}`;

        const itemsTotal = getCart().reduce((s, i) => s + i.price * i.quantity, 0);
        document.getElementById("checkoutTotal").innerText =
          `üí≥ Total : ${(itemsTotal + deliveryPrice).toFixed(2).replace(".", ",")} ‚Ç¨`;

        box.style.display = "none";
      };

      box.appendChild(div);
    });
  }, 300);
});

// ============================================
// CONFIRMER COMMANDE
// ============================================
window.confirmOrder = async function(){
  const user = window.currentUser;
  
  // ========================================== 
  // MODIFICATION 1: CONNEXION AUTO CHECKOUT
  // ========================================== 
  if(!user){ 
    window.openLoginMenu(); 
    showMessage("Connectez-vous pour continuer"); 
    return; 
  }

  const cart = getCart();
  if(cart.length === 0){ showMessage("Panier vide"); return; }

  // V√©rif panier minimum
  const itemsTotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
  if(itemsTotal < PANIER_MINIMUM){
    showMessage(`Minimum ${PANIER_MINIMUM}‚Ç¨ requis pour commander`);
    return;
  }

  // V√©rif max par commande
  for(const item of cart){
    if(item.maxPerDelivery > 0 && item.quantity > item.maxPerDelivery){
      showMessage(`${item.name} : maximum ${item.maxPerDelivery} par commande`);
      return;
    }
  }

  // ========================================== 
  // MODIFICATION 2: V√âRIF CHECKBOX ALCOOL
  // ========================================== 
  if(window.commerceVendAlcool === true){
    const alcoholCheck = document.getElementById("alcoholCheck");
    if(!alcoholCheck.checked){
      showMessage("Vous devez certifier avoir plus de 18 ans pour continuer");
      return;
    }
  }

  if(!selectedAddressLatLng){
    showMessage("Veuillez s√©lectionner une adresse valide");
    return;
  }

  const commerceSnap = await getDoc(doc(db, "commerces", cart[0].commerceId));
  if(!commerceSnap.exists()){ showMessage("Commerce introuvable"); return; }

  const commerce = commerceSnap.data();

  if(!commerce.lat || !commerce.lng){
    showMessage("Position du commerce non d√©finie");
    return;
  }

  const distance = getDistanceKm(
    commerce.lat, commerce.lng,
    selectedAddressLatLng.lat, selectedAddressLatLng.lng
  );

  if(distance > ZONE_MAX_KM){
    showMessage(`‚ùå Adresse hors zone (${ZONE_MAX_KM} km max)`);
    return;
  }

  const name    = document.getElementById("custName").value.trim();
  const phone   = document.getElementById("custPhone").value.trim();
  const address = document.getElementById("custAddress").value.trim();

  if(!name || !phone || !address){
    showMessage("Veuillez remplir tous les champs");
    return;
  }

  const deliveryPrice = getDeliveryPrice(distance);

  // Commission dynamique depuis Firestore
  const commission    = commerce.commission || 15; // 15% par d√©faut, 10% pour Cave Nicolas
  const commissionAmount = itemsTotal * (commission / 100);

  const total = itemsTotal + deliveryPrice;

  try {
    await addDoc(collection(db, "commandes"), {
      commerceId:        cart[0].commerceId,
      clientId:          user.uid,
      client: {
        nom:     name,
        tel:     phone,
        adresse: address
      },
      items: cart.map(i => ({
        productId: i.productId,
        name:      i.name,
        price:     i.price,
        qty:       i.quantity
      })),
      itemsTotal,
      deliveryPrice,
      distanceKm:        parseFloat(distance.toFixed(2)),
      commission,
      commissionAmount:  parseFloat(commissionAmount.toFixed(2)),
      total,
      status:            "en_attente",
      createdAt:         serverTimestamp()
    });

    showMessage("‚úÖ Commande envoy√©e !");
    clearCart();
    closeCheckoutForm();
    showPage('mesCommandes');

  } catch(e){
    showMessage("Erreur : " + e.message);
  }
};

// ============================================
// AUTH
// ============================================
window.login = async function(){
  const email    = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth, email, password); }
  catch(e) { showMessage("Email ou mot de passe incorrect"); }
}

window.register = async function(){
  const email    = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(db, "users", cred.user.uid), {
      email, role: "client", createdAt: new Date()
    });
    showMessage("Compte cr√©√© ‚úÖ");
  } catch(e) { showMessage("Erreur inscription"); }
}

window.openLoginMenu = function(){
  toggleMenu();
  const box = document.getElementById("authBox");
  box.style.display   = "block";
  box.style.opacity   = 0;
  box.style.transform = "scale(0.9)";
  setTimeout(() => {
    box.style.transition = "all 0.3s ease";
    box.style.opacity    = 1;
    box.style.transform  = "scale(1)";
  }, 10);
}

window.logout = function(){
  auth.signOut()
    .then(() => showMessage("D√©connect√© ‚úÖ"))
    .catch(() => showMessage("Erreur d√©connexion"));
}

onAuthStateChanged(auth, user => {
  const authBox   = document.getElementById("authBox");
  const loginBtn  = document.getElementById("menuLoginBtn");
  const logoutBtn = document.getElementById("menuLogoutBtn");
  if(user){
    authBox.style.display   = "none";
    window.currentUser      = user;
    loginBtn.style.display  = "none";
    logoutBtn.style.display = "block";
  } else {
    window.currentUser      = null;
    loginBtn.style.display  = "block";
    logoutBtn.style.display = "none";
  }
});

// ============================================
// MES COMMANDES CLIENT
// ============================================
window.renderClientOrders = function(){
  const container = document.getElementById("ordersClient");
  if(!window.currentUser){ container.innerHTML = "<p>Veuillez vous connecter</p>"; return; }

  container.innerHTML = "Chargement...";

  const q = query(
    collection(db, "commandes"),
    where("clientId", "==", window.currentUser.uid)
  );

  onSnapshot(q, snapshot => {
    container.innerHTML = "";

    if(snapshot.empty){ container.innerHTML = "<p>Aucune commande pour le moment</p>"; return; }

    snapshot.forEach(docSnap => {
      const o     = docSnap.data();
      const steps = ["en_attente", "prete", "en_livraison", "livree"];
      const idx   = steps.indexOf(o.status);

      const date = o.createdAt?.toDate?.()?.toLocaleDateString('fr-FR') || "";

      container.innerHTML += `
        <div style="padding:1.5rem;margin-bottom:1rem;background:#FEFEFE;border-radius:20px;
                    box-shadow:0 8px 20px rgba(107,44,62,0.08);border:2px solid #F5F1E8;">
          <strong style="color:#6B2C3E;font-family:'Playfair Display',serif;">Commande</strong>
          ${date ? `<span style="float:right;color:#6B6B6B;font-size:0.85rem;">${date}</span>` : ""}
          <br>
          üí∞ Total : <strong>${o.total.toFixed(2)} ‚Ç¨</strong><br>
          <div class="status-bar" style="margin:0.8rem 0;">
            ${steps.map((s, i) => `<div class="status-step ${i <= idx ? "active" : ""}"></div>`).join("")}
          </div>
          <small style="color:#6B6B6B;">üì¶ ${o.status.replace(/_/g, " ")}</small>
        </div>
      `;
    });
  });
}

// ============================================
// CALCUL DISTANCE (Haversine)
// ============================================
function getDistanceKm(lat1, lng1, lat2, lng2){
  const R    = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a    =
    Math.sin(dLat/2) * Math.