<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Livraison Locale - Pro</title>

<style>
/* RESET */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;background:#f6f7f9;color:#1a1a1a;line-height:1.5}

/* HEADER */
header{background:linear-gradient(135deg,#00b4d8,#0077b6);color:white;padding:1.5rem 1rem;border-bottom-left-radius:20px;border-bottom-right-radius:20px;position:relative}
header h1{font-size:1.8rem;margin-bottom:.3rem}
header p{opacity:.9;font-size:.95rem}
#cta{margin-top:1rem;display:flex;gap:1rem}
#cta button{flex:1;padding:.9rem;border:none;border-radius:14px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.2s}
#orderBtn{background:white;color:#0077b6}
#orderBtn:hover{background:#f0f0f0}
#menuBtn{background:rgba(255,255,255,.2);color:white}
#menuBtn:hover{background:rgba(255,255,255,.3)}

/* MOBILE MENU */
#mobileMenu{display:none;background:white;position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;padding:2rem;overflow-y:auto;box-shadow:0 0 25px rgba(0,0,0,0.25);transform:translateX(-100%);transition:transform 0.3s ease;}
#mobileMenu.show{transform:translateX(0);}
#mobileMenu a{display:block;padding:1rem 0;font-size:1.2rem;font-weight:600;color:#0077b6;border-bottom:1px solid #eee;cursor:pointer}
#mobileMenuOverlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:998;opacity:0;transition:opacity 0.3s;}
#mobileMenuOverlay.show{display:block;opacity:1;}

/* SECTIONS */
section{padding:1.5rem 1rem;max-width:900px;margin:auto}
h2{margin-bottom:1rem;transition:all 0.2s}

/* GRID LISTES */
#categoryList,#commerceList,#productList{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;transition:all 0.3s}
.category,.commerce,.product{background:white;padding:1rem;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);cursor:pointer;transition:transform 0.2s,box-shadow 0.2s,background 0.3s}
.category:hover,.commerce:hover,.product:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
.category.selected,.commerce.selected{background:#caf0f8}

/* PRODUCT BUTTON */
.product span{font-weight:600;display:block}
.stock{font-size:.85rem;color:#666;margin:.3rem 0}
.product button{margin-top:.6rem;width:100%;padding:.7rem;border:none;border-radius:12px;background:#0077b6;color:white;font-weight:600;cursor:pointer;transition:all 0.2s}
.product button:hover:not(:disabled){background:#0096d6;transform:translateY(-1px)}
.product button:disabled{background:#ccc;opacity:0.6;cursor:not-allowed}

/* PANIER FLOTANT */
#cartFloating{position:fixed;bottom:20px;right:20px;width:280px;background:#fff;border-radius:16px;box-shadow:0 6px 25px rgba(0,0,0,0.15);padding:1rem;z-index:600;transition:transform 0.3s,opacity 0.3s;opacity:0;transform:translateY(100px);}
#cartFloating.show{opacity:1;transform:translateY(0);}
#cartFloating h3{margin-bottom:.5rem;color:#0077b6;text-align:center;}
#cartFloating div{padding:.8rem;border-bottom:1px solid #eee;border-radius:12px;margin-bottom:0.6rem;background:#fefefe;box-shadow:0 2px 10px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center;transition:all 0.2s;}
#cartFloating div:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,0.1);}
#cartFloating button{padding:.3rem .6rem;border:none;border-radius:8px;background:#0077b6;color:white;font-weight:600;cursor:pointer;transition:all 0.2s;}
#cartFloating button:hover{background:#0096d6;transform:translateY(-1px);}
#cartFloating button:disabled{background:#ccc;cursor:not-allowed;}

/* BADGE PANIER */
#cartBadge{position:absolute;top:-10px;right:-10px;background:#ff595e;color:white;border-radius:50%;width:22px;height:22px;font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.2)}

/* MESSAGE CENTRAL */
#addedMessage,#errorMessage{
  position: fixed; top:50%; left:50%; transform:translate(-50%, -50%);
  padding:1rem 2rem; border-radius:12px; font-weight:600;font-size:1rem; display:none; z-index:1001;
  box-shadow:0 6px 20px rgba(0,0,0,.3); text-align:center; opacity:0; transition:opacity 0.3s ease;
}
#addedMessage{background:#4caf50; color:white;}
#addedMessage.show, #errorMessage.show{display:block; opacity:1;}
#errorMessage{background:#d00000;color:white;}

/* MOBILE RESPONSIVE */
@media(max-width:767px){
  #cartFloating{width:90%;right:5%;bottom:20px;}
  #categoryList,#commerceList,#productList{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<header>
  <h1>Livraison Locale</h1>
  <p>Commerces des Sables d‚ÄôOlonne</p>
  <div id="cta">
    <button id="orderBtn" onclick="showPage('commander')">Commander</button>
    <button id="menuBtn" onclick="toggleMenu()">Menu</button>
  </div>
</header>

<div id="mobileMenuOverlay" onclick="toggleMenu()"></div>
<div id="mobileMenu">
  <a onclick="nav('accueil')">Accueil</a>
  <a onclick="nav('apropos')">√Ä propos</a>
  <a onclick="nav('contact')">Contact</a>
  <a href="inscription.html">Nous rejoindre</a>
</div>

<section id="accueil">
<h2>Bienvenue</h2>
<p>Commandez local, simplement.</p>
</section>

<section id="apropos" style="display:none">
<h2>√Ä propos</h2>
<p>Plateforme locale de livraison.</p>
</section>

<section id="contact" style="display:none">
<h2>Contact</h2>
<p>cedric.huet.pro@gmail.com</p>
</section>

<section id="commander" style="display:none">
<h2>Choisir une cat√©gorie</h2>
<div id="categoryList"></div>
<div id="commerceList"></div>
<div id="productList"></div>
</section>

<div id="cartFloating" class="show">
<h3>üõí Panier <span id="cartBadge">0</span></h3>
<div id="cart"></div>
<button onclick="clearCart()" style="width:100%;background:#ff595e;color:white;border:none;padding:.8rem;border-radius:12px">Vider le panier</button>
</div>

<div id="errorMessage"></div>
<div id="addedMessage">Produit ajout√© ‚úÖ</div>

<script>
// MENU
function toggleMenu(){
  const m=document.getElementById("mobileMenu"); 
  const o=document.getElementById("mobileMenuOverlay");
  m.classList.toggle("show");
  o.classList.toggle("show");
}
function nav(p){toggleMenu(); showPage(p);}
function showPage(p){['accueil','apropos','contact','commander'].forEach(id=>document.getElementById(id).style.display='none'); document.getElementById(p).style.display='block';}

// MESSAGE
function showMessage(msg){const el=document.getElementById("errorMessage"); el.innerText=msg; el.classList.add("show"); setTimeout(()=>{el.classList.remove("show");},2000);}
function showAddedMessage(){const el=document.getElementById("addedMessage"); el.classList.add("show"); setTimeout(()=>{el.classList.remove("show");},1000);}

// PANIER
function getCart(){return JSON.parse(localStorage.getItem("panier"))||[];}
function saveCart(cart){localStorage.setItem("panier",JSON.stringify(cart)); renderCart();}
function clearCart(){localStorage.removeItem("panier"); renderCart(); selectedCommerceId=null;}
let selectedCommerceId=null;
function addToCart(commerceId, productId, name, price, stock){
  if(selectedCommerceId && selectedCommerceId!==commerceId){ showMessage("Vous ne pouvez commander qu'un seul magasin √† la fois"); return; }
  selectedCommerceId = commerceId;
  let cart = getCart();
  price=parseFloat(price.toString().replace(",","."));  
  const existing = cart.find(p=>p.productId===productId && p.commerceId===commerceId);
  if(existing){
    if(existing.quantity>=stock){ showMessage("Stock limit√©"); return; }
    existing.quantity+=1;
  } else{
    if(stock<1){ showMessage("Produit non disponible"); return; }
    cart.push({commerceId,productId,name,price,quantity:1,stock});
  }
  saveCart(cart); 
  showAddedMessage();
}
function removeFromCart(productId){let cart=getCart(); cart=cart.filter(p=>p.productId!==productId); if(cart.length===0) selectedCommerceId=null; saveCart(cart);}
function updateQuantity(productId, qty){let cart=getCart(); const item=cart.find(p=>p.productId===productId); if(item){
  if(qty>item.stock){ showMessage("Stock limit√©"); return; }
  item.quantity=Math.max(1, qty);
} saveCart(cart);}
function renderCart(){
  const container=document.getElementById("cart"); 
  const badge=document.getElementById("cartBadge");
  const cart=getCart(); 
  container.innerHTML=""; 
  if(cart.length===0){container.innerHTML="<p>Panier vide</p>"; badge.innerText="0"; return;}
  let total=0; 
  cart.forEach(item=>{
    total+=item.price*item.quantity; 
    container.innerHTML+=`
      <div>
        <span>${item.name} - ${item.price.toFixed(2).replace(".",",")}‚Ç¨ x ${item.quantity}</span>
        <button onclick="removeFromCart('${item.productId}')">‚ùå</button>
      </div>`;
  }); 
  container.innerHTML+=`<h3>Total : ${total.toFixed(2).replace(".",",")} ‚Ç¨</h3>`;
  badge.innerText=cart.reduce((acc,i)=>acc+i.quantity,0);
}
document.addEventListener("DOMContentLoaded", renderCart);
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise",
  storageBucket: "livraison-sablaise.firebasestorage.app",
  messagingSenderId: "930839535214",
  appId: "1:930839535214:web:a3235919aa88d066bc507f",
  measurementId: "G-R3ZCGLQ69E"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const categoryList=document.getElementById("categoryList");
const commerceList=document.getElementById("commerceList");
const productList=document.getElementById("productList");

let categoriesSet = new Set();
let commerceCategories = {};

async function loadCategories(){
  const snapshot = await getDocs(collection(db,"commerces"));
  snapshot.forEach(docSnap=>{
    const c=docSnap.data();
    const cat=c.category || "Autres";
    categoriesSet.add(cat);
    commerceCategories[docSnap.id]=cat;
  });
  categoryList.innerHTML="";
  [...categoriesSet].sort().forEach(cat=>{
    const div=document.createElement("div");
    div.className="category";
    div.dataset.opened = "false";
    div.innerHTML=`${cat} <span style="float:right;cursor:pointer">&#9654;</span>`;
    div.onclick=()=>{
      if(div.dataset.opened==="true"){ commerceList.innerHTML=""; productList.innerHTML=""; div.dataset.opened="false"; div.classList.remove("selected"); return; }
      [...categoryList.children].forEach(c=>{c.dataset.opened="false"; c.classList.remove("selected");});
      div.dataset.opened="true"; div.classList.add("selected");
      showCommercesByCategory(cat);
    };
    categoryList.appendChild(div);
  });
}

function showCommercesByCategory(cat){
  productList.innerHTML="";
  commerceList.innerHTML="<h3>Commerces</h3>";
  getDocs(collection(db,"commerces")).then(snapshot=>{
    snapshot.forEach(docSnap=>{
      if((docSnap.data().category || "Autres")===cat){
        const div=document.createElement("div");
        div.className="commerce";
        div.dataset.opened="false";
        div.innerHTML=`${docSnap.data().name} <span style="float:right;cursor:pointer">&#9660;</span>`;
        div.onclick=()=>{
          if(div.dataset.opened==="true"){ productList.innerHTML=""; div.dataset.opened="false"; div.classList.remove("selected"); return; }
          [...commerceList.children].forEach(c=>{c.dataset.opened="false"; c.classList.remove("selected");});
          div.dataset.opened="true"; div.classList.add("selected");
          showProducts(docSnap.id);
        };
        commerceList.appendChild(div);
      }
    });
  });
  productList.innerHTML="";
}

function showProducts(commerceId){
  productList.innerHTML="<h3>Produits</h3>";
  const productsRef=collection(db,"commerces",commerceId,"produits");
  onSnapshot(productsRef,snapshot=>{
    productList.innerHTML="<h3>Produits</h3>";
    snapshot.forEach(docSnap=>{
      const p=docSnap.data();
      const stock = p.stock || 10;
      const div=document.createElement("div");
      div.className="product";
      const price=p.price.toString().replace(".",",");
      div.innerHTML=`<span>${p.name} - ${price}‚Ç¨</span>
      <span class="stock">Stock : ${stock}</span>`;
      const btn=document.createElement("button");
      btn.innerText="Ajouter au panier";
      btn.disabled=!p.available || stock<1;
      btn.onclick=()=>addToCart(commerceId,docSnap.id,p.name,p.price,stock);
      div.appendChild(btn);
      productList.appendChild(div);
    });
  });
}

loadCategories();
</script>

</body>
</html>
