<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Livraison Locale</title>
<style>
/* RESET */
*{margin:0;padding:0;box-sizing:border-box}
/* BASE */
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; background:#f6f7f9;color:#1a1a1a;}
/* HEADER */
header{background:linear-gradient(135deg,#00b4d8,#0077b6);color:white;padding:1.5rem 1rem;border-bottom-left-radius:20px;border-bottom-right-radius:20px;}
header h1{font-size:1.8rem;margin-bottom:.3rem;}
header p{opacity:.9;font-size:.95rem;}
/* TOP ACTION */
#cta{margin-top:1rem;display:flex;gap:1rem;}
#cta button{flex:1;padding:.9rem;border:none;border-radius:14px;font-size:1rem;font-weight:600;cursor:pointer;}
#orderBtn{background:white;color:#0077b6;}
#menuBtn{background:rgba(255,255,255,.2);color:white;}
/* MOBILE MENU */
#mobileMenu{display:none;background:white;position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;padding:2rem;}
#mobileMenu a{display:block;padding:1rem 0;font-size:1.2rem;font-weight:600;color:#0077b6;border-bottom:1px solid #eee;}
/* SECTIONS */
section{padding:1.5rem 1rem;max-width:900px;margin:auto;}
h2{margin-bottom:1rem;}
/* LISTS */
#commerceList,#productList{display:grid;grid-template-columns:1fr;gap:1rem;}
.commerce,.product{background:white;padding:1rem;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);}
.product span{font-weight:600;display:block;}
.stock{font-size:.85rem;color:#666;margin:.3rem 0;}
.product button{margin-top:.6rem;width:100%;padding:.7rem;border:none;border-radius:12px;background:#0077b6;color:white;font-weight:600;}
.product button:disabled{background:#ccc;}
/* CART */
#cart div{padding:.7rem 0;border-bottom:1px solid #eee;}
#cart button{margin:0 .2rem;}
#message{text-align:center;color:#d00000;margin:1rem;display:none;}
/* DESKTOP */
@media(min-width:768px){#commerceList,#productList{grid-template-columns:repeat(2,1fr);}}
</style>
</head>

<body>
<header>
  <h1>Livraison Locale</h1>
  <p>Commerces des Sables dâ€™Olonne</p>
  <div id="cta">
    <button id="orderBtn" onclick="showPage('commander')">Commander</button>
    <button id="menuBtn" onclick="toggleMenu()">Menu</button>
  </div>
</header>

<div id="mobileMenu">
  <a onclick="nav('accueil')">Accueil</a>
  <a onclick="nav('apropos')">Ã€ propos</a>
  <a onclick="nav('contact')">Contact</a>
  <a href="inscription.html">Nous rejoindre</a>
</div>

<section id="accueil">
  <h2>Bienvenue</h2>
  <p>Commandez local, simplement.</p>
</section>

<section id="apropos" style="display:none">
  <h2>Ã€ propos</h2>
  <p>Plateforme locale de livraison.</p>
</section>

<section id="contact" style="display:none">
  <h2>Contact</h2>
  <p>cedric.huet.pro@gmail.com</p>
</section>

<section id="commander" style="display:none">
  <h2>Choisir un commerce</h2>
  <div id="commerceList"></div>
  <div id="productList"></div>
  <p id="message"></p>
</section>

<section>
  <h2>ðŸ›’ Panier</h2>
  <div id="cart"></div>
  <button onclick="clearCart()" style="width:100%;background:#ff595e;color:white;border:none;padding:.8rem;border-radius:12px">Vider le panier</button>
</section>

<script>
// MENU
function toggleMenu(){
  const m=document.getElementById("mobileMenu");
  m.style.display=m.style.display==="block"?"none":"block";
}
function nav(p){toggleMenu();showPage(p);}
function showPage(p){['accueil','apropos','contact','commander'].forEach(id=>document.getElementById(id).style.display='none');document.getElementById(p).style.display='block';}

// PANIER
let currentStore = null;
function getCart(){return JSON.parse(localStorage.getItem("panier"))||[];}
function saveCart(cart){localStorage.setItem("panier",JSON.stringify(cart));}
function renderCart(){
  const container=document.getElementById("cart");
  const cart=getCart();
  container.innerHTML="";
  if(cart.length===0){container.innerHTML="<p>Panier vide</p>"; currentStore=null; return;}
  let total=0;
  cart.forEach(item=>{
    total+=item.price*item.quantity;
    container.innerHTML+=`
      <div>
        <strong>${item.name}</strong> â€“ ${item.price.toFixed(2).replace(".",",")}â‚¬<br>
        QuantitÃ© :
        <button onclick="updateQuantity('${item.commerceId}','${item.productId}',${item.quantity-1})">-</button>
        ${item.quantity}
        <button onclick="updateQuantity('${item.commerceId}','${item.productId}',${item.quantity+1})">+</button>
        <br>
        <button onclick="removeFromCart('${item.commerceId}','${item.productId}')">Supprimer</button>
      </div>`;
  });
  container.innerHTML+=`<h3>Total : ${total.toFixed(2).replace(".",",")} â‚¬</h3>`;
}
function clearCart(){localStorage.removeItem("panier"); currentStore=null; renderCart();}
function addToCart(commerceId,productId,name,price,stock){
  let cart=getCart();
  price=parseFloat(price.toString().replace(",","."));
  if(currentStore && currentStore!==commerceId){showTempMessage("Vous ne pouvez commander qu'un seul magasin Ã  la fois"); return;}
  let existing=cart.find(p=>p.productId===productId && p.commerceId===commerceId);
  let currentQty = existing?existing.quantity:0;
  if(currentQty>=stock){showTempMessage("Stock limitÃ©"); return;}
  if(existing){existing.quantity+=1;} else{cart.push({commerceId,productId,name,price,quantity:1}); currentStore=commerceId;}
  saveCart(cart); renderCart();
}
function updateQuantity(commerceId,productId,newQty){
  let cart=getCart();
  const item=cart.find(p=>p.commerceId===commerceId && p.productId===productId);
  if(!item) return;
  if(newQty<1){removeFromCart(commerceId,productId); return;}
  if(newQty>item.stock){showTempMessage("Stock limitÃ©"); return;}
  item.quantity=newQty;
  saveCart(cart); renderCart();
}
function removeFromCart(commerceId,productId){let cart=getCart(); cart=cart.filter(p=>!(p.commerceId===commerceId && p.productId===productId)); saveCart(cart); renderCart();}
function showTempMessage(msg){const m=document.getElementById("message");m.innerText=msg; m.style.display="block"; setTimeout(()=>{m.style.display="none"},2000);}
document.addEventListener("DOMContentLoaded",renderCart);
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise",
  storageBucket: "livraison-sablaise.firebasestorage.app",
  messagingSenderId: "930839535214",
  appId: "1:930839535214:web:a3235919aa88d066bc507f",
  measurementId: "G-R3ZCGLQ69E"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// COMMERCE + PRODUITS
const commerceList=document.getElementById("commerceList");
const productList=document.getElementById("productList");

async function loadCommerces(){
  const snapshot = await getDocs(collection(db,"commerces"));
  commerceList.innerHTML="";
  snapshot.forEach(docSnap=>{
    const c = docSnap.data();
    const div=document.createElement("div");
    div.className="commerce";
    div.innerText=c.name;
    div.onclick=()=>loadProducts(docSnap.id);
    commerceList.appendChild(div);
  });
}

function loadProducts(commerceId){
  const productsRef=collection(db,"commerces",commerceId,"produits");
  onSnapshot(productsRef, snapshot=>{
    productList.innerHTML="<h3>Produits</h3>";
    snapshot.forEach(docSnap=>{
      const p = docSnap.data();
      const div=document.createElement("div");
      div.className="product";
      const price = p.price.toString().replace(".",",");
      const stock = p.stock || 999; // par dÃ©faut si pas dÃ©fini
      div.innerHTML=`<span>${p.name} - ${price}â‚¬ ${!p.available?"(Non disponible)":""}</span>
                       <div class="stock">Stock restant : ${stock}</div>`;
      const btn=document.createElement("button");
      btn.innerText="Ajouter au panier";
      btn.disabled=!p.available;
      btn.onclick=()=>addToCart(commerceId,docSnap.id,p.name,p.price,stock);
      div.appendChild(btn);
      productList.appendChild(div);
    });
  });
}

loadCommerces();
</script>
</body>
</html>
