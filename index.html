<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Livraison Locale</title>

<style>
/* RESET */
*{margin:0;padding:0;box-sizing:border-box}

/* BASE */
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#f6f7f9;
  color:#1a1a1a;
}

/* HEADER */
header{
  background:linear-gradient(135deg,#00b4d8,#0077b6);
  color:white;
  padding:1.5rem 1rem;
  border-bottom-left-radius:20px;
  border-bottom-right-radius:20px;
}
header h1{font-size:1.8rem;margin-bottom:.3rem;}
header p{opacity:.9;font-size:.95rem;}

/* TOP ACTION */
#cta{
  margin-top:1rem;
  display:flex;
  gap:1rem;
}
#cta button{
  flex:1;
  padding:.9rem;
  border:none;
  border-radius:14px;
  font-size:1rem;
  font-weight:600;
  cursor:pointer;
}
#orderBtn{background:white;color:#0077b6;}
#menuBtn{background:rgba(255,255,255,.2);color:white;}

/* MOBILE MENU */
#mobileMenu{
  display:none;
  background:white;
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  z-index:999;
  padding:2rem;
}
#mobileMenu a{
  display:block;
  padding:1rem 0;
  font-size:1.2rem;
  font-weight:600;
  color:#0077b6;
  border-bottom:1px solid #eee;
}

/* SECTIONS */
section{
  padding:1.5rem 1rem;
  max-width:900px;
  margin:auto;
}
h2{margin-bottom:1rem;}

/* LISTS */
#commerceList,#productList,#categoryList{
  display:grid;
  grid-template-columns:1fr;
  gap:1rem;
}

.category, .commerce, .product{
  background:white;
  padding:1rem;
  border-radius:16px;
  box-shadow:0 6px 20px rgba(0,0,0,.06);
  cursor:pointer;
}

/* PRODUCT */
.product span{font-weight:600;display:block;}
.stock{font-size:.85rem;color:#666;margin:.3rem 0;}
.product button{
  margin-top:.6rem;width:100%;padding:.7rem;border:none;border-radius:12px;background:#0077b6;color:white;font-weight:600;
}
.product button:disabled{background:#ccc;cursor:not-allowed;}

/* CART */
#cart div{padding:.7rem 0;border-bottom:1px solid #eee;}
#cart button{margin:0 .2rem;}

/* MESSAGE */
#message{
  text-align:center;color:#d00000;margin:1rem;display:none;padding:.5rem;border:1px solid #d00000;border-radius:8px;
  background:#ffe5e5;
  animation: fadeout 2s forwards;
}
@keyframes fadeout{
  0%{opacity:1}
  80%{opacity:1}
  100%{opacity:0;display:none}
}

/* DESKTOP */
@media(min-width:768px){
  #commerceList,#productList,#categoryList{
    grid-template-columns:repeat(2,1fr);
  }
}
</style>
</head>

<body>

<header>
  <h1>Livraison Locale</h1>
  <p>Commerces des Sables dâ€™Olonne</p>
  <div id="cta">
    <button id="orderBtn" onclick="showPage('commander')">Commander</button>
    <button id="menuBtn" onclick="toggleMenu()">Menu</button>
  </div>
</header>

<div id="mobileMenu">
  <a onclick="nav('accueil')">Accueil</a>
  <a onclick="nav('apropos')">Ã€ propos</a>
  <a onclick="nav('contact')">Contact</a>
  <a href="inscription.html">Nous rejoindre</a>
</div>

<section id="accueil">
<h2>Bienvenue</h2>
<p>Commandez local, simplement.</p>
</section>

<section id="apropos" style="display:none">
<h2>Ã€ propos</h2>
<p>Plateforme locale de livraison.</p>
</section>

<section id="contact" style="display:none">
<h2>Contact</h2>
<p>cedric.huet.pro@gmail.com</p>
</section>

<section id="commander" style="display:none">
<h2>Choisir une catÃ©gorie</h2>
<div id="categoryList"></div>
<div id="commerceList"></div>
<div id="productList"></div>
<p id="message"></p>
</section>

<section>
<h2>ðŸ›’ Panier</h2>
<div id="cart"></div>
<button onclick="clearCart()" style="width:100%;background:#ff595e;color:white;border:none;padding:.8rem;border-radius:12px">
Vider le panier
</button>
</section>

<script>
// MENU
function toggleMenu(){document.getElementById("mobileMenu").style.display=document.getElementById("mobileMenu").style.display==="block"?"none":"block";}
function nav(p){toggleMenu(); showPage(p);}
function showPage(p){['accueil','apropos','contact','commander'].forEach(id=>document.getElementById(id).style.display='none');document.getElementById(p).style.display='block';}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// ðŸ”‘ CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyB1mljASb5TevqJ1ucDqgXsYQZqEnNxQts",
  authDomain: "livraison-sablaise.firebaseapp.com",
  projectId: "livraison-sablaise",
  storageBucket: "livraison-sablaise.firebasestorage.app",
  messagingSenderId: "930839535214",
  appId: "1:930839535214:web:a3235919aa88d066bc507f",
  measurementId: "G-R3ZCGLQ69E"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// PANIER
let currentShop=null;
function getCart(){return JSON.parse(localStorage.getItem("panier"))||[];}
function saveCart(cart){localStorage.setItem("panier",JSON.stringify(cart));}
function addToCart(commerceId,productId,name,price,stock){
  if(currentShop && currentShop!==commerceId){
    showMessage("Vous ne pouvez commander qu'un seul magasin Ã  la fois");
    return;
  }
  let cart=getCart();
  price=parseFloat(price.toString().replace(",","."));
  const existing=cart.find(p=>p.productId===productId && p.commerceId===commerceId);
  if(existing){
    if(existing.quantity>=stock){showMessage("Stock maximum atteint"); return;}
    existing.quantity+=1;
  }else{
    cart.push({commerceId,productId,name,price,quantity:1});
    currentShop=commerceId;
  }
  saveCart(cart); renderCart();
}
function updateQuantity(productId,qty,stock,commerceId){
  let cart=getCart();
  const item=cart.find(p=>p.productId===productId && p.commerceId===commerceId);
  if(item){
    if(qty>stock){showMessage("Stock maximum atteint"); return;}
    if(qty<1){cart=cart.filter(p=>p.productId!==productId); if(cart.length===0) currentShop=null;}
    else item.quantity=qty;
  }
  saveCart(cart); renderCart();
}
function removeFromCart(productId,commerceId){
  let cart=getCart();
  cart=cart.filter(p=>!(p.productId===productId && p.commerceId===commerceId));
  if(cart.length===0) currentShop=null;
  saveCart(cart); renderCart();
}
function clearCart(){localStorage.removeItem("panier"); currentShop=null; renderCart();}
function renderCart(){
  const container=document.getElementById("cart"); const cart=getCart(); container.innerHTML="";
  if(cart.length===0){container.innerHTML="<p>Panier vide</p>"; return;}
  let total=0;
  cart.forEach(item=>{
    total+=item.price*item.quantity;
    container.innerHTML+=`
      <div>
        <strong>${item.name}</strong> â€“ ${(item.price.toFixed(2)).replace(".",",")}â‚¬<br>
        QuantitÃ© :
        <button onclick="updateQuantity('${item.productId}',${item.quantity-1},999,'${item.commerceId}')">-</button>
        ${item.quantity}
        <button onclick="updateQuantity('${item.productId}',${item.quantity+1},999,'${item.commerceId}')">+</button>
        <br>
        <button onclick="removeFromCart('${item.productId}','${item.commerceId}')">Supprimer</button>
      </div>`;
  });
  container.innerHTML+=`<h3>Total : ${(total.toFixed(2)).replace(".",",")} â‚¬</h3>`;
}
function showMessage(msg){
  const m=document.getElementById("message"); m.innerText=msg; m.style.display="block";
  setTimeout(()=>{m.style.display="none";},2000);
}
document.addEventListener("DOMContentLoaded",renderCart);

// CATEGORIES ET COMMERCES
const categoryList=document.getElementById("categoryList");
const commerceList=document.getElementById("commerceList");
const productList=document.getElementById("productList");
let openedCommerce=null;

async function loadCategories(){
  const categories=['Pharmacie','Boulangerie','Patisserie']; // tu peux complÃ©ter
  categoryList.innerHTML="";
  categories.forEach(cat=>{
    const div=document.createElement("div");
    div.className="category";
    div.innerText=cat;
    div.onclick=()=>showCommercesByCategory(cat);
    categoryList.appendChild(div);
  });
}

function showCommercesByCategory(cat){
  productList.innerHTML=""; commerceList.innerHTML="<h3>Commerces</h3>";
  getDocs(collection(db,"commerces")).then(snapshot=>{
    commerceList.innerHTML="<h3>Commerces</h3>";
    snapshot.forEach(docSnap=>{
      if((docSnap.data().category||"Autres")===cat){
        const div=document.createElement("div");
        div.className="commerce";
        div.innerHTML=`${docSnap.data().name} <span style="float:right">&#9660;</span>`;
        div.onclick=()=>{
          if(openedCommerce===docSnap.id){productList.innerHTML=""; openedCommerce=null; return;}
          openedCommerce=docSnap.id; showProducts(docSnap.id);
        };
        commerceList.appendChild(div);
      }
    });
  });
}

function showProducts(commerceId){
  productList.innerHTML="<h3>Produits</h3>";
  const productsRef=collection(db,"commerces",commerceId,"produits");
  onSnapshot(productsRef,snapshot=>{
    productList.innerHTML="<h3>Produits</h3>";
    snapshot.forEach(docSnap=>{
      const p=docSnap.data(); const stock=p.stock||10;
      const div=document.createElement("div"); div.className="product";
      const price=p.price.toString().replace(".",",");
      div.innerHTML=`<span>${p.name} - ${price}â‚¬</span><span class="stock">Stock : ${stock}</span>`;
      const btn=document.createElement("button"); btn.innerText="Ajouter au panier"; btn.disabled=!p.available || stock<1;
      btn.onclick=()=>addToCart(commerceId,docSnap.id,p.name,p.price,stock);
      div.appendChild(btn);
      productList.appendChild(div);
    });
  });
}

loadCategories();
</script>

</body>
</html>
